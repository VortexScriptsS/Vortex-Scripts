local VortexUI = {}
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local player = game.Players.LocalPlayer

-- Load Icons module
local Icons = loadstring(game:HttpGet("https://raw.githubusercontent.com/Footagesus/Icons/refs/heads/main/lucide/dist/Icons.lua"))()

--[[
    ╔══════════════════════════════════════════════════════════════════╗
    ║                    VORTEX UI - MODERN DESIGN SYSTEM              ║
    ║          Premium UI Library with 2026 Design Standards           ║
    ╚══════════════════════════════════════════════════════════════════╝
    
    Design Philosophy:
    - Glassmorphism with subtle depth
    - Spring-based micro-interactions
    - Token-based color system
    - Accessibility-first approach
]]

-- ══════════════════════════════════════════════════════════════════════
-- DESIGN TOKENS - Modern 2026 Color System
-- ══════════════════════════════════════════════════════════════════════
local CONFIG = {
    -- Surface colors - Deep, rich layers with clear elevation
    SURFACE_0 = Color3.fromRGB(10, 10, 12),        -- Deepest background
    SURFACE_1 = Color3.fromRGB(18, 18, 22),        -- Main background
    SURFACE_2 = Color3.fromRGB(26, 26, 32),        -- Elevated surface (sidebar, header)
    SURFACE_3 = Color3.fromRGB(34, 34, 42),        -- Cards, panels
    SURFACE_4 = Color3.fromRGB(44, 44, 54),        -- Interactive elements (inputs, buttons)
    SURFACE_HOVER = Color3.fromRGB(52, 52, 64),    -- Hover state
    
    -- Text hierarchy - Clear contrast ratios (WCAG AA compliant)
    TEXT_PRIMARY = Color3.fromRGB(250, 250, 252),   -- Primary text - 15.8:1 contrast
    TEXT_SECONDARY = Color3.fromRGB(180, 182, 190), -- Secondary text - 8.2:1 contrast
    TEXT_MUTED = Color3.fromRGB(110, 112, 124),     -- Muted/disabled - 4.6:1 contrast
    TEXT_INVERSE = Color3.fromRGB(10, 10, 12),      -- Text on accent backgrounds
    
    -- Border system - Subtle definition
    BORDER_SUBTLE = Color3.fromRGB(48, 50, 60),     -- Subtle borders
    BORDER_DEFAULT = Color3.fromRGB(58, 60, 72),    -- Default borders
    BORDER_STRONG = Color3.fromRGB(72, 74, 88),     -- Strong borders
    BORDER_ACCENT = Color3.fromRGB(99, 102, 241),   -- Accent borders (focus states)
    
    -- Primary accent - Modern indigo/violet blend
    ACCENT_PRIMARY = Color3.fromRGB(99, 102, 241),   -- Primary accent
    ACCENT_HOVER = Color3.fromRGB(79, 82, 221),      -- Hover state
    ACCENT_ACTIVE = Color3.fromRGB(67, 70, 200),     -- Active/pressed
    ACCENT_GLOW = Color3.fromRGB(129, 132, 255),     -- Glow effect
    ACCENT_SUBTLE = Color3.fromRGB(99, 102, 241),    -- For subtle tints (use with transparency)
    
    -- Semantic colors - Status indicators
    SUCCESS = Color3.fromRGB(34, 197, 94),
    SUCCESS_GLOW = Color3.fromRGB(74, 222, 128),
    SUCCESS_SUBTLE = Color3.fromRGB(22, 163, 74),
    
    ERROR = Color3.fromRGB(239, 68, 68),
    ERROR_GLOW = Color3.fromRGB(252, 129, 129),
    ERROR_SUBTLE = Color3.fromRGB(220, 38, 38),
    
    WARNING = Color3.fromRGB(245, 158, 11),
    WARNING_GLOW = Color3.fromRGB(251, 191, 36),
    
    INFO = Color3.fromRGB(59, 130, 246),
    INFO_GLOW = Color3.fromRGB(96, 165, 250),
    
    -- Design tokens - Spacing and radii
    RADIUS_SM = UDim.new(0, 6),
    RADIUS_MD = UDim.new(0, 10),
    RADIUS_LG = UDim.new(0, 14),
    RADIUS_XL = UDim.new(0, 18),
    RADIUS_FULL = UDim.new(1, 0),
    
    -- Animation timing (in seconds)
    DURATION_INSTANT = 0.1,
    DURATION_FAST = 0.15,
    DURATION_NORMAL = 0.25,
    DURATION_SLOW = 0.35,
    DURATION_SLOWER = 0.5,
    
    -- Shadow system
    SHADOW_COLOR = Color3.fromRGB(0, 0, 0),
    SHADOW_AMBIENT = 0.4,
    SHADOW_DIRECT = 0.6,
    
    -- Border thickness
    BORDER_WIDTH = 1,
    BORDER_WIDTH_FOCUS = 2,
    
    -- Glassmorphism
    GLASS_BLUR = 12,
    GLASS_TRANSPARENCY = 0.15
}

-- ══════════════════════════════════════════════════════════════════════
-- RESPONSIVE DESIGN SYSTEM
-- ══════════════════════════════════════════════════════════════════════
local Responsive = {
    Breakpoints = {
        Mobile = { Width = 768, Height = 1024 },
        Tablet = { Width = 1024, Height = 768 },
        Desktop = { Width = 1920, Height = 1080 }
    },
    
    ScaleFactors = {
        Mobile = { UI = 0.75, Font = 0.88, Spacing = 0.85 },
        Tablet = { UI = 0.88, Font = 0.94, Spacing = 0.92 },
        Desktop = { UI = 1.0, Font = 1.0, Spacing = 1.0 }
    },
    
    CurrentCategory = "Desktop",
    CurrentScale = { UI = 1.0, Font = 1.0, Spacing = 1.0 }
}

local function GetScreenCategory()
    local viewportSize = workspace.CurrentCamera.ViewportSize
    local width, height = viewportSize.X, viewportSize.Y
    
    if width <= Responsive.Breakpoints.Mobile.Width or height <= Responsive.Breakpoints.Mobile.Height then
        return "Mobile"
    elseif width <= Responsive.Breakpoints.Tablet.Width or height <= Responsive.Breakpoints.Tablet.Height then
        return "Tablet"
    else
        return "Desktop"
    end
end

local function UpdateResponsiveScale()
    local category = GetScreenCategory()
    Responsive.CurrentCategory = category
    Responsive.CurrentScale = Responsive.ScaleFactors[category]
end

local function Scale(baseSize, scaleType)
    scaleType = scaleType or "UI"
    local scale = Responsive.CurrentScale[scaleType] or 1.0
    return math.floor(baseSize * scale + 0.5)
end

local function ScaleUDim2(baseUDim2, scaleX, scaleY)
    scaleX = scaleX or "UI"
    scaleY = scaleY or "UI"
    local scaleXValue = Responsive.CurrentScale[scaleX] or 1.0
    local scaleYValue = Responsive.CurrentScale[scaleY] or 1.0
    
    return UDim2.new(
        baseUDim2.X.Scale,
        math.floor(baseUDim2.X.Offset * scaleXValue + 0.5),
        baseUDim2.Y.Scale,
        math.floor(baseUDim2.Y.Offset * scaleYValue + 0.5)
    )
end

local function ScaleFont(baseSize)
    return math.max(11, Scale(baseSize, "Font"))
end

-- ══════════════════════════════════════════════════════════════════════
-- STATE MANAGEMENT
-- ══════════════════════════════════════════════════════════════════════
local Elements = {}
local ToggleStates = {}
local WindowInstances = {}
local KeySystem = {
    Enabled = false,
    ValidKeys = {},
    Authenticated = false,
    LastValidKey = nil
}

-- Cleanup system
local CleanupManager = {
    ActiveConnections = {},
    ActiveLoops = {},
    ActiveToggles = {},
    CleanupCallbacks = {}
}

-- ══════════════════════════════════════════════════════════════════════
-- UTILITY FUNCTIONS
-- ══════════════════════════════════════════════════════════════════════
local function CreateElement(elementType, properties)
    local element = Instance.new(elementType)
    for prop, value in pairs(properties) do
        element[prop] = value
    end
    
    if elementType == "TextButton" then
        element.AutoButtonColor = properties.AutoButtonColor ~= false
        element.TextColor3 = properties.TextColor3 or CONFIG.TEXT_PRIMARY
        element.TextSize = properties.TextSize or ScaleFont(14)
        element.Font = properties.Font or Enum.Font.GothamMedium
    end
    
    if elementType == "TextLabel" then
        element.Font = properties.Font or Enum.Font.GothamMedium
    end
    
    if elementType == "TextBox" then
        element.Font = properties.Font or Enum.Font.GothamMedium
    end
    
    return element
end

local function AddCorner(parent, radius)
    local corner = Instance.new("UICorner")
    corner.CornerRadius = radius or CONFIG.RADIUS_MD
    corner.Parent = parent
    return corner
end

local function AddStroke(parent, thickness, color, transparency)
    local stroke = CreateElement("UIStroke", {
        Thickness = thickness or CONFIG.BORDER_WIDTH,
        Color = color or CONFIG.BORDER_DEFAULT,
        Transparency = transparency or 0,
        ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    })
    stroke.Parent = parent
    return stroke
end

local function AddPadding(parent, top, right, bottom, left)
    local padding = CreateElement("UIPadding", {
        PaddingTop = UDim.new(0, top or 0),
        PaddingRight = UDim.new(0, right or top or 0),
        PaddingBottom = UDim.new(0, bottom or top or 0),
        PaddingLeft = UDim.new(0, left or right or top or 0)
    })
    padding.Parent = parent
    return padding
end

-- Modern shadow with multiple layers for depth
local function AddShadow(parent, intensity)
    intensity = intensity or "md"
    
    local shadowConfig = {
        sm = { offset = 2, spread = 4, transparency = 0.75 },
        md = { offset = 4, spread = 12, transparency = 0.65 },
        lg = { offset = 8, spread = 24, transparency = 0.55 },
        xl = { offset = 12, spread = 36, transparency = 0.45 }
    }
    
    local config = shadowConfig[intensity] or shadowConfig.md
    
    -- Ambient shadow (soft, spread out)
    local ambientShadow = CreateElement("ImageLabel", {
        Name = "AmbientShadow",
        AnchorPoint = Vector2.new(0.5, 0.5),
        BackgroundTransparency = 1,
        Position = UDim2.new(0.5, 0, 0.5, config.offset / 2),
        Size = UDim2.new(1, config.spread * 2, 1, config.spread * 2),
        ZIndex = parent.ZIndex - 2,
        Image = "rbxassetid://6015897843",
        ImageColor3 = CONFIG.SHADOW_COLOR,
        ImageTransparency = config.transparency + 0.1,
        ScaleType = Enum.ScaleType.Slice,
        SliceCenter = Rect.new(49, 49, 450, 450)
    })
    ambientShadow.Parent = parent
    
    -- Direct shadow (sharper, offset)
    local directShadow = CreateElement("ImageLabel", {
        Name = "DirectShadow",
        AnchorPoint = Vector2.new(0.5, 0.5),
        BackgroundTransparency = 1,
        Position = UDim2.new(0.5, 0, 0.5, config.offset),
        Size = UDim2.new(1, config.spread, 1, config.spread),
        ZIndex = parent.ZIndex - 1,
        Image = "rbxassetid://6015897843",
        ImageColor3 = CONFIG.SHADOW_COLOR,
        ImageTransparency = config.transparency,
        ScaleType = Enum.ScaleType.Slice,
        SliceCenter = Rect.new(49, 49, 450, 450)
    })
    directShadow.Parent = parent
    
    return { ambient = ambientShadow, direct = directShadow }
end

-- Subtle gradient for depth perception
local function AddGradient(parent, rotation, startAlpha, endAlpha)
    local gradient = Instance.new("UIGradient")
    local baseColor = parent.BackgroundColor3
    
    gradient.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, Color3.new(
            math.min(1, baseColor.R + 0.02),
            math.min(1, baseColor.G + 0.02),
            math.min(1, baseColor.B + 0.02)
        )),
        ColorSequenceKeypoint.new(1, Color3.new(
            math.max(0, baseColor.R - 0.015),
            math.max(0, baseColor.G - 0.015),
            math.max(0, baseColor.B - 0.015)
        ))
    }
    gradient.Rotation = rotation or 180
    
    if startAlpha and endAlpha then
        gradient.Transparency = NumberSequence.new{
            NumberSequenceKeypoint.new(0, startAlpha),
            NumberSequenceKeypoint.new(1, endAlpha)
        }
    end
    
    gradient.Parent = parent
    return gradient
end

-- Inner glow effect for active states
local function AddInnerGlow(parent, color, size)
    local glow = CreateElement("Frame", {
        Name = "InnerGlow",
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        BorderSizePixel = 0,
        ZIndex = parent.ZIndex + 1
    })
    glow.Parent = parent
    
    local glowStroke = AddStroke(glow, size or 3, color or CONFIG.ACCENT_GLOW, 0.7)
    AddCorner(glow, parent:FindFirstChildOfClass("UICorner") and parent:FindFirstChildOfClass("UICorner").CornerRadius or CONFIG.RADIUS_MD)
    
    return glow, glowStroke
end

-- Spring-like easing (using Back for approximation)
local function CreateSpringTween(object, duration, properties)
    return TweenService:Create(
        object,
        TweenInfo.new(duration, Enum.EasingStyle.Back, Enum.EasingDirection.Out, 0, false, 0),
        properties
    )
end

-- Smooth easing for most animations
local function CreateSmoothTween(object, duration, properties)
    return TweenService:Create(
        object,
        TweenInfo.new(duration, Enum.EasingStyle.Quart, Enum.EasingDirection.Out),
        properties
    )
end

-- Quick easing for hover states
local function CreateQuickTween(object, duration, properties)
    return TweenService:Create(
        object,
        TweenInfo.new(duration, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
        properties
    )
end

-- Elastic easing for playful interactions
local function CreateElasticTween(object, duration, properties)
    return TweenService:Create(
        object,
        TweenInfo.new(duration, Enum.EasingStyle.Elastic, Enum.EasingDirection.Out),
        properties
    )
end

-- ══════════════════════════════════════════════════════════════════════
-- CLEANUP MANAGEMENT
-- ══════════════════════════════════════════════════════════════════════
local function TrackConnection(connection, window)
    if not CleanupManager.ActiveConnections[window] then
        CleanupManager.ActiveConnections[window] = {}
    end
    table.insert(CleanupManager.ActiveConnections[window], connection)
    return connection
end

local function TrackLoop(loopFunction, window, loopName)
    if not CleanupManager.ActiveLoops[window] then
        CleanupManager.ActiveLoops[window] = {}
    end
    CleanupManager.ActiveLoops[window][loopName] = loopFunction
end

local function TrackToggle(toggleCallback, window, toggleName)
    if not CleanupManager.ActiveToggles[window] then
        CleanupManager.ActiveToggles[window] = {}
    end
    CleanupManager.ActiveToggles[window][toggleName] = toggleCallback
end

local function AddCleanupCallback(callback, window)
    if not CleanupManager.CleanupCallbacks[window] then
        CleanupManager.CleanupCallbacks[window] = {}
    end
    table.insert(CleanupManager.CleanupCallbacks[window], callback)
end

local function CleanupWindow(window)
    if CleanupManager.ActiveConnections[window] then
        for _, connection in ipairs(CleanupManager.ActiveConnections[window]) do
            if connection and connection.Disconnect then
                connection:Disconnect()
            end
        end
        CleanupManager.ActiveConnections[window] = {}
    end
    
    if CleanupManager.ActiveLoops[window] then
        for loopName, loopFunction in pairs(CleanupManager.ActiveLoops[window]) do
            if type(loopFunction) == "function" then
                pcall(loopFunction, false)
            end
        end
        CleanupManager.ActiveLoops[window] = {}
    end
    
    if CleanupManager.ActiveToggles[window] then
        for toggleName, toggleCallback in pairs(CleanupManager.ActiveToggles[window]) do
            if type(toggleCallback) == "function" then
                pcall(toggleCallback, false)
            end
        end
        CleanupManager.ActiveToggles[window] = {}
    end
    
    if CleanupManager.CleanupCallbacks[window] then
        for _, callback in ipairs(CleanupManager.CleanupCallbacks[window]) do
            if type(callback) == "function" then
                pcall(callback)
            end
        end
        CleanupManager.CleanupCallbacks[window] = {}
    end
    
    for flag in pairs(ToggleStates) do
        if type(ToggleStates[flag]) == "boolean" then
            ToggleStates[flag] = false
        end
    end
end

-- ══════════════════════════════════════════════════════════════════════
-- RIPPLE EFFECT COMPONENT
-- ══════════════════════════════════════════════════════════════════════
local function CreateRipple(parent, position, color)
    local ripple = CreateElement("Frame", {
        Name = "Ripple",
        AnchorPoint = Vector2.new(0.5, 0.5),
        BackgroundColor3 = color or CONFIG.TEXT_PRIMARY,
        BackgroundTransparency = 0.7,
        Position = position,
        Size = UDim2.new(0, 0, 0, 0),
        ZIndex = parent.ZIndex + 10,
        BorderSizePixel = 0
    })
    AddCorner(ripple, CONFIG.RADIUS_FULL)
    ripple.Parent = parent
    
    local maxSize = math.max(parent.AbsoluteSize.X, parent.AbsoluteSize.Y) * 2.5
    
    local expandTween = CreateSmoothTween(ripple, 0.4, {
        Size = UDim2.new(0, maxSize, 0, maxSize),
        BackgroundTransparency = 1
    })
    
    expandTween:Play()
    expandTween.Completed:Connect(function()
        ripple:Destroy()
    end)
end

-- ══════════════════════════════════════════════════════════════════════
-- MAIN WINDOW CREATION
-- ══════════════════════════════════════════════════════════════════════
function VortexUI:CreateWindow(options)
    local windowName = options.Name or "Vortex UI"
    local keySystem = options.KeySystem or nil
    local onWindowCreated = options.OnWindowCreated or nil
    
    UpdateResponsiveScale()
    
    if keySystem then
        KeySystem.Enabled = true
        KeySystem.ValidKeys = keySystem.ValidKeys or {}
        KeySystem.Authenticated = false
        
        if not KeySystem.Authenticated then
            VortexUI:ShowKeyWindow(function(success)
                if success then
                    KeySystem.Authenticated = true
                    local windowOptions = {
                        Name = windowName,
                        KeySystem = nil,
                        OnWindowCreated = onWindowCreated
                    }
                    VortexUI:CreateWindow(windowOptions)
                end
            end, KeySystem)
            return nil
        end
    end
    
    local window = {}
    
    local CoreGui = game:GetService("CoreGui")
    for _, child in ipairs(CoreGui:GetChildren()) do
        if child.Name == "VortexUI" then
            child:Destroy()
        end
    end
    
    local screenGui = CreateElement("ScreenGui", {
        Name = "VortexUI",
        IgnoreGuiInset = true,
        ZIndexBehavior = Enum.ZIndexBehavior.Sibling,
        ResetOnSpawn = false
    })
    screenGui.Parent = CoreGui
    
    -- Calculate window dimensions
    local baseWindowSize = UDim2.new(0, 640, 0, 420)
    local windowSize = ScaleUDim2(baseWindowSize)
    local windowPos = UDim2.new(0.5, -windowSize.X.Offset/2, 0.5, -windowSize.Y.Offset/2)
    
    -- Main container with shadow
    local mainContainer = CreateElement("Frame", {
        Name = "MainContainer",
        Size = windowSize,
        Position = windowPos,
        BackgroundTransparency = 1,
        BorderSizePixel = 0
    })
    mainContainer.Parent = screenGui
    
    -- Main window frame
    local mainFrame = CreateElement("Frame", {
        Name = "MainFrame",
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundColor3 = CONFIG.SURFACE_1,
        BorderSizePixel = 0,
        ClipsDescendants = true
    })
    mainFrame.Parent = mainContainer
    
    AddCorner(mainFrame, CONFIG.RADIUS_XL)
    AddStroke(mainFrame, 1, CONFIG.BORDER_SUBTLE, 0.3)
    AddShadow(mainFrame, "xl")
    
    -- Subtle noise texture overlay for depth
    local noiseOverlay = CreateElement("ImageLabel", {
        Name = "NoiseOverlay",
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        Image = "rbxassetid://8992230677",
        ImageTransparency = 0.97,
        ScaleType = Enum.ScaleType.Tile,
        TileSize = UDim2.new(0, 128, 0, 128),
        ZIndex = mainFrame.ZIndex + 100
    })
    noiseOverlay.Parent = mainFrame
    AddCorner(noiseOverlay, CONFIG.RADIUS_XL)
    
    -- ════════════════════════════════════════════════════════════════
    -- HEADER BAR
    -- ════════════════════════════════════════════════════════════════
    local headerHeight = Scale(52)
    local headerBar = CreateElement("Frame", {
        Name = "HeaderBar",
        Size = UDim2.new(1, 0, 0, headerHeight),
        Position = UDim2.new(0, 0, 0, 0),
        BackgroundColor3 = CONFIG.SURFACE_2,
        BorderSizePixel = 0,
        ZIndex = 10
    })
    headerBar.Parent = mainFrame
    
    -- Header corners (top only)
    local headerCorner = AddCorner(headerBar, CONFIG.RADIUS_XL)
    
    local headerCover = CreateElement("Frame", {
        Name = "HeaderCover",
        Size = UDim2.new(1, 0, 0, 20),
        Position = UDim2.new(0, 0, 1, -20),
        BackgroundColor3 = CONFIG.SURFACE_2,
        BorderSizePixel = 0,
        ZIndex = headerBar.ZIndex
    })
    headerCover.Parent = headerBar
    
    -- Subtle header gradient
    AddGradient(headerBar, 180)
    
    -- Header divider with subtle glow
    local headerDivider = CreateElement("Frame", {
        Name = "HeaderDivider",
        Size = UDim2.new(1, 0, 0, 1),
        Position = UDim2.new(0, 0, 1, 0),
        BackgroundColor3 = CONFIG.BORDER_SUBTLE,
        BorderSizePixel = 0,
        ZIndex = headerBar.ZIndex + 1
    })
    headerDivider.Parent = headerBar
    
    -- Logo container with glow effect
    local logoSize = Scale(36)
    local logoContainer = CreateElement("Frame", {
        Name = "LogoContainer",
        Size = UDim2.new(0, logoSize, 0, logoSize),
        Position = UDim2.new(0, Scale(14), 0.5, -logoSize/2),
        BackgroundColor3 = CONFIG.SURFACE_0,
        BorderSizePixel = 0,
        ZIndex = headerBar.ZIndex + 2
    })
    logoContainer.Parent = headerBar
    AddCorner(logoContainer, CONFIG.RADIUS_MD)
    
    -- Logo glow ring
    local logoGlow = CreateElement("Frame", {
        Name = "LogoGlow",
        Size = UDim2.new(1, 8, 1, 8),
        Position = UDim2.new(0.5, 0, 0.5, 0),
        AnchorPoint = Vector2.new(0.5, 0.5),
        BackgroundColor3 = CONFIG.ACCENT_PRIMARY,
        BackgroundTransparency = 0.85,
        BorderSizePixel = 0,
        ZIndex = logoContainer.ZIndex - 1
    })
    logoGlow.Parent = logoContainer
    AddCorner(logoGlow, CONFIG.RADIUS_LG)
    
    local logoImage = CreateElement("ImageLabel", {
        Name = "LogoImage",
        Size = UDim2.new(1, -8, 1, -8),
        Position = UDim2.new(0.5, 0, 0.5, 0),
        AnchorPoint = Vector2.new(0.5, 0.5),
        BackgroundTransparency = 1,
        Image = "rbxassetid://97748628737538",
        ImageTransparency = 0,
        ZIndex = logoContainer.ZIndex + 1
    })
    logoImage.Parent = logoContainer
    
    -- Window title with improved typography
    local titleLabel = CreateElement("TextLabel", {
        Name = "TitleLabel",
        Size = UDim2.new(1, -Scale(180), 0, Scale(22)),
        Position = UDim2.new(0, Scale(62), 0.5, -Scale(11)),
        BackgroundTransparency = 1,
        Text = windowName,
        TextColor3 = CONFIG.TEXT_PRIMARY,
        TextSize = ScaleFont(16),
        Font = Enum.Font.GothamBold,
        TextXAlignment = Enum.TextXAlignment.Left,
        ZIndex = headerBar.ZIndex + 2
    })
    titleLabel.Parent = headerBar
    
    -- ════════════════════════════════════════════════════════════════
    -- WINDOW CONTROLS (Modern pill design)
    -- ════════════════════════════════════════════════════════════════
    local controlsContainer = CreateElement("Frame", {
        Name = "ControlsContainer",
        Size = ScaleUDim2(UDim2.new(0, 76, 0, 30)),
        Position = UDim2.new(1, -Scale(90), 0.5, -Scale(15)),
        BackgroundColor3 = CONFIG.SURFACE_3,
        BorderSizePixel = 0,
        ZIndex = headerBar.ZIndex + 2
    })
    controlsContainer.Parent = headerBar
    AddCorner(controlsContainer, UDim.new(0, Scale(15)))
    AddStroke(controlsContainer, 1, CONFIG.BORDER_SUBTLE, 0.5)
    
    -- Minimize button
    local minimizeButton = CreateElement("TextButton", {
        Name = "MinimizeButton",
        Size = ScaleUDim2(UDim2.new(0, 30, 0, 24)),
        Position = UDim2.new(0, Scale(3), 0.5, -Scale(12)),
        BackgroundColor3 = CONFIG.SURFACE_4,
        BackgroundTransparency = 1,
        BorderSizePixel = 0,
        Text = "",
        AutoButtonColor = false,
        ZIndex = controlsContainer.ZIndex + 1
    })
    minimizeButton.Parent = controlsContainer
    AddCorner(minimizeButton, CONFIG.RADIUS_SM)
    
    local minimizeIcon = CreateElement("TextLabel", {
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        Text = "−",
        TextColor3 = CONFIG.TEXT_SECONDARY,
        TextSize = ScaleFont(18),
        Font = Enum.Font.GothamBold,
        ZIndex = minimizeButton.ZIndex + 1
    })
    minimizeIcon.Parent = minimizeButton
    
    -- Close button
    local closeButton = CreateElement("TextButton", {
        Name = "CloseButton",
        Size = ScaleUDim2(UDim2.new(0, 30, 0, 24)),
        Position = UDim2.new(1, -Scale(33), 0.5, -Scale(12)),
        BackgroundColor3 = CONFIG.SURFACE_4,
        BackgroundTransparency = 1,
        BorderSizePixel = 0,
        Text = "",
        AutoButtonColor = false,
        ZIndex = controlsContainer.ZIndex + 1
    })
    closeButton.Parent = controlsContainer
    AddCorner(closeButton, CONFIG.RADIUS_SM)
    
    local closeIcon = CreateElement("TextLabel", {
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        Text = "×",
        TextColor3 = CONFIG.TEXT_SECONDARY,
        TextSize = ScaleFont(20),
        Font = Enum.Font.GothamBold,
        ZIndex = closeButton.ZIndex + 1
    })
    closeIcon.Parent = closeButton
    
    -- Control button hover effects with micro-interactions
    minimizeButton.MouseEnter:Connect(function()
        CreateQuickTween(minimizeButton, CONFIG.DURATION_FAST, {
            BackgroundTransparency = 0
        }):Play()
        CreateQuickTween(minimizeIcon, CONFIG.DURATION_FAST, {
            TextColor3 = CONFIG.TEXT_PRIMARY
        }):Play()
    end)
    
    minimizeButton.MouseLeave:Connect(function()
        CreateQuickTween(minimizeButton, CONFIG.DURATION_FAST, {
            BackgroundTransparency = 1
        }):Play()
        CreateQuickTween(minimizeIcon, CONFIG.DURATION_FAST, {
            TextColor3 = CONFIG.TEXT_SECONDARY
        }):Play()
    end)
    
    closeButton.MouseEnter:Connect(function()
        CreateQuickTween(closeButton, CONFIG.DURATION_FAST, {
            BackgroundTransparency = 0,
            BackgroundColor3 = CONFIG.ERROR
        }):Play()
        CreateQuickTween(closeIcon, CONFIG.DURATION_FAST, {
            TextColor3 = CONFIG.TEXT_PRIMARY
        }):Play()
    end)
    
    closeButton.MouseLeave:Connect(function()
        CreateQuickTween(closeButton, CONFIG.DURATION_FAST, {
            BackgroundTransparency = 1,
            BackgroundColor3 = CONFIG.SURFACE_4
        }):Play()
        CreateQuickTween(closeIcon, CONFIG.DURATION_FAST, {
            TextColor3 = CONFIG.TEXT_SECONDARY
        }):Play()
    end)
    
    -- ════════════════════════════════════════════════════════════════
    -- MINIMIZE FUNCTIONALITY
    -- ════════════════════════════════════════════════════════════════
    local isMinimized = false
    local originalSize = mainContainer.Size
    local originalPosition = mainContainer.Position
    local minimizedSize = ScaleUDim2(UDim2.new(0, 200, 0, 52))
    local originalVisibilities = {}
    local currentTween = nil
    
    local function keepInBounds(position, size)
        local viewportSize = workspace.CurrentCamera.ViewportSize
        local x = position.X.Offset + position.X.Scale * viewportSize.X
        local y = position.Y.Offset + position.Y.Scale * viewportSize.Y
        local width = size.X.Offset + size.X.Scale * viewportSize.X
        local height = size.Y.Offset + size.Y.Scale * viewportSize.Y
        
        x = math.max(0, math.min(x, viewportSize.X - width))
        y = math.max(0, math.min(y, viewportSize.Y - height))
        
        return UDim2.new(0, x, 0, y)
    end
    
    -- ════════════════════════════════════════════════════════════════
    -- CONTENT LAYOUT
    -- ════════════════════════════════════════════════════════════════
    local contentFrame = CreateElement("Frame", {
        Name = "ContentFrame",
        Size = UDim2.new(1, 0, 1, -headerHeight),
        Position = UDim2.new(0, 0, 0, headerHeight),
        BackgroundColor3 = CONFIG.SURFACE_1,
        BorderSizePixel = 0,
        ZIndex = 5
    })
    contentFrame.Parent = mainFrame
    
    -- Sidebar
    local sidebarWidth = Responsive.CurrentCategory == "Mobile" and Scale(140) or Scale(180)
    local sidebarFrame = CreateElement("Frame", {
        Name = "SidebarFrame",
        Size = UDim2.new(0, sidebarWidth, 1, 0),
        Position = UDim2.new(0, 0, 0, 0),
        BackgroundColor3 = CONFIG.SURFACE_2,
        BorderSizePixel = 0,
        ZIndex = 6
    })
    sidebarFrame.Parent = contentFrame
    
    -- Sidebar right border
    local sidebarBorder = CreateElement("Frame", {
        Name = "SidebarBorder",
        Size = UDim2.new(0, 1, 1, 0),
        Position = UDim2.new(1, 0, 0, 0),
        BackgroundColor3 = CONFIG.BORDER_SUBTLE,
        BorderSizePixel = 0,
        ZIndex = sidebarFrame.ZIndex + 1
    })
    sidebarBorder.Parent = sidebarFrame
    
    AddPadding(sidebarFrame, Scale(12), Scale(10), Scale(12), Scale(10))
    
    -- Tab layout
    local tabLayout = CreateElement("UIListLayout", {
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, Scale(6))
    })
    tabLayout.Parent = sidebarFrame
    
    -- Content area with modern scrollbar
    local contentArea = CreateElement("ScrollingFrame", {
        Name = "ContentArea",
        Size = UDim2.new(1, -sidebarWidth, 1, 0),
        Position = UDim2.new(0, sidebarWidth, 0, 0),
        BackgroundColor3 = CONFIG.SURFACE_1,
        BorderSizePixel = 0,
        ScrollBarThickness = Scale(4),
        ScrollBarImageColor3 = CONFIG.ACCENT_PRIMARY,
        ScrollBarImageTransparency = 0.4,
        TopImage = "rbxassetid://6015897843",
        MidImage = "rbxassetid://6015897843",
        BottomImage = "rbxassetid://6015897843",
        ZIndex = 5
    })
    contentArea.Parent = contentFrame
    contentArea.ClipsDescendants = true
    
    -- ════════════════════════════════════════════════════════════════
    -- MINIMIZE/MAXIMIZE LOGIC
    -- ════════════════════════════════════════════════════════════════
    local function updateMinimizedState()
        local tweenInfo = TweenInfo.new(CONFIG.DURATION_SLOW, Enum.EasingStyle.Back, Enum.EasingDirection.Out)
        
        if isMinimized then
            originalPosition = mainContainer.Position
            originalVisibilities = {}
            
            for _, child in ipairs(mainFrame:GetChildren()) do
                if child:IsA("GuiObject") and not child:IsA("UIListLayout") and not child:IsA("UIPadding") then
                    originalVisibilities[child] = child.Visible
                end
            end
            
            local minimizedPos = keepInBounds(mainContainer.Position, minimizedSize)
            
            if currentTween then currentTween:Cancel() end
            currentTween = TweenService:Create(mainContainer, tweenInfo, {
                Size = minimizedSize,
                Position = minimizedPos
            })
            currentTween:Play()
            
            for _, child in ipairs(mainFrame:GetChildren()) do
                if child ~= headerBar and child:IsA("GuiObject") and not child:IsA("UIListLayout") and not child:IsA("UIPadding") and child.Name ~= "NoiseOverlay" then
                    child.Visible = false
                end
            end
            
            headerBar.Visible = true
            
            for _, child in ipairs(headerBar:GetChildren()) do
                if child:IsA("GuiObject") and not child:IsA("UIListLayout") and not child:IsA("UIPadding") and not child:IsA("UICorner") and not child:IsA("UIGradient") then
                    if child ~= logoContainer and child ~= controlsContainer and child ~= titleLabel and child.Name ~= "HeaderCover" and child.Name ~= "HeaderDivider" then
                        child.Visible = false
                    else
                        child.Visible = true
                    end
                end
            end
            
            headerBar.Size = UDim2.new(1, 0, 1, 0)
            titleLabel.Visible = false
        else
            local restoredPos = keepInBounds(originalPosition, originalSize)
            
            if currentTween then currentTween:Cancel() end
            currentTween = TweenService:Create(mainContainer, tweenInfo, {
                Size = originalSize,
                Position = restoredPos
            })
            currentTween:Play()
            
            for child, wasVisible in pairs(originalVisibilities) do
                if child.Parent then
                    child.Visible = wasVisible
                end
            end
            
            if contentArea then contentArea.Visible = true end
            if sidebarFrame then sidebarFrame.Visible = true end
            if titleLabel then titleLabel.Visible = true end
            if contentFrame then contentFrame.Visible = true end
            
            headerBar.Size = UDim2.new(1, 0, 0, headerHeight)
            originalPosition = restoredPos
        end
    end
    
    minimizeButton.MouseButton1Click:Connect(function()
        isMinimized = not isMinimized
        updateMinimizedState()
    end)
    
    -- ════════════════════════════════════════════════════════════════
    -- DRAGGING SYSTEM
    -- ════════════════════════════════════════════════════════════════
    local dragging = false
    local dragInput
    local dragStart
    local startPos
    
    local function update(input)
        local delta = input.Position - dragStart
        local newPosition = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        local boundedPosition = keepInBounds(newPosition, isMinimized and minimizedSize or mainContainer.Size)
        mainContainer.Position = boundedPosition
    end
    
    local function handleDragStart(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = mainContainer.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                    if not isMinimized then
                        originalPosition = mainContainer.Position
                    end
                end
            end)
        end
    end
    
    local function handleInputChanged(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end
    
    local function setupDrag(element)
        element.InputBegan:Connect(handleDragStart)
        element.InputChanged:Connect(handleInputChanged)
    end
    
    setupDrag(headerBar)
    setupDrag(logoContainer)
    
    local dragConnection = UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            update(input)
        end
    end)
    
    TrackConnection(dragConnection, window)
    
    -- Close button functionality
    closeButton.MouseButton1Click:Connect(function()
        -- Exit animation
        CreateSmoothTween(mainContainer, CONFIG.DURATION_NORMAL, {
            Size = UDim2.new(0, 0, 0, 0),
            Position = UDim2.new(0.5, 0, 0.5, 0)
        }):Play()
        
        task.wait(CONFIG.DURATION_NORMAL)
        CleanupWindow(window)
        screenGui:Destroy()
    end)
    
    -- Destruction detection
    local windowNameVar = "VortexUI"
    local cleanupCalled = false
    
    local destructionConnection
    destructionConnection = RunService.Heartbeat:Connect(function()
        if not screenGui or not screenGui.Parent then
            if not cleanupCalled then
                cleanupCalled = true
                if destructionConnection then
                    destructionConnection:Disconnect()
                end
                CleanupWindow(window)
            end
        end
    end)
    
    local coreGuiConnection
    coreGuiConnection = CoreGui.ChildRemoved:Connect(function(child)
        if child.Name == windowNameVar then
            if not cleanupCalled then
                cleanupCalled = true
                if destructionConnection then
                    destructionConnection:Disconnect()
                end
                if coreGuiConnection then
                    coreGuiConnection:Disconnect()
                end
                CleanupWindow(window)
            end
        end
    end)
    
    TrackConnection(destructionConnection, window)
    TrackConnection(coreGuiConnection, window)
    
    -- Responsive resize handling
    local viewportSizeConnection = workspace.CurrentCamera:GetPropertyChangedSignal("ViewportSize"):Connect(function()
        local oldCategory = Responsive.CurrentCategory
        UpdateResponsiveScale()
        
        if oldCategory ~= Responsive.CurrentCategory then
            local newWindowSize = ScaleUDim2(baseWindowSize)
            local newWindowPos = UDim2.new(0.5, -newWindowSize.X.Offset/2, 0.5, -newWindowSize.Y.Offset/2)
            
            CreateSmoothTween(mainContainer, CONFIG.DURATION_NORMAL, {
                Size = newWindowSize,
                Position = newWindowPos
            }):Play()
            
            local newSidebarWidth = Responsive.CurrentCategory == "Mobile" and Scale(140) or Scale(180)
            CreateSmoothTween(sidebarFrame, CONFIG.DURATION_NORMAL, {
                Size = UDim2.new(0, newSidebarWidth, 1, 0)
            }):Play()
            
            CreateSmoothTween(contentArea, CONFIG.DURATION_NORMAL, {
                Size = UDim2.new(1, -newSidebarWidth, 1, 0),
                Position = UDim2.new(0, newSidebarWidth, 0, 0)
            }):Play()
        end
    end)
    
    TrackConnection(viewportSizeConnection, window)
    
    WindowInstances[window] = {
        ScreenGui = screenGui,
        MainFrame = mainFrame,
        MainContainer = mainContainer,
        ContentFrame = contentFrame,
        SidebarFrame = sidebarFrame,
        ContentArea = contentArea,
        Tabs = {}
    }
    
    -- ════════════════════════════════════════════════════════════════
    -- TAB CREATION
    -- ════════════════════════════════════════════════════════════════
    function window:CreateTab(options)
        local tabName = options.Name or "New Tab"
        local iconName = options.Icon
        local tab = {}
        
        local tabCount = 0
        for _ in pairs(WindowInstances[window].Tabs) do
            tabCount = tabCount + 1
        end
        
        -- Modern tab button
        local tabButton = CreateElement("TextButton", {
            Name = "TabButton_" .. tabName,
            Size = UDim2.new(1, 0, 0, Scale(42)),
            BackgroundColor3 = CONFIG.SURFACE_3,
            BackgroundTransparency = 1,
            BorderSizePixel = 0,
            Text = "",
            AutoButtonColor = false,
            LayoutOrder = tabCount,
            ZIndex = 10
        })
        tabButton.Parent = sidebarFrame
        
        AddCorner(tabButton, CONFIG.RADIUS_MD)
        
        -- Icon container with accent tint on active
        local tabIconContainer = CreateElement("Frame", {
            Name = "IconContainer",
            Size = ScaleUDim2(UDim2.new(0, 30, 0, 30)),
            Position = UDim2.new(0, Scale(8), 0.5, -Scale(15)),
            BackgroundColor3 = CONFIG.ACCENT_PRIMARY,
            BackgroundTransparency = 1,
            BorderSizePixel = 0,
            ZIndex = tabButton.ZIndex + 1
        })
        tabIconContainer.Parent = tabButton
        AddCorner(tabIconContainer, CONFIG.RADIUS_SM)
        
        local tabLabel = CreateElement("TextLabel", {
            Name = "TabLabel",
            Size = UDim2.new(1, -Scale(50), 1, 0),
            Position = UDim2.new(0, Scale(44), 0, 0),
            BackgroundTransparency = 1,
            Text = tabName,
            TextColor3 = CONFIG.TEXT_SECONDARY,
            TextSize = ScaleFont(13),
            Font = Enum.Font.GothamMedium,
            TextXAlignment = Enum.TextXAlignment.Left,
            ZIndex = tabButton.ZIndex + 1
        })
        tabLabel.Parent = tabButton
        
        local tabIcon = nil
        if iconName and Icons[iconName] then
            tabIcon = CreateElement("ImageLabel", {
                Name = "TabIcon",
                Size = ScaleUDim2(UDim2.new(0, 18, 0, 18)),
                Position = UDim2.new(0.5, 0, 0.5, 0),
                AnchorPoint = Vector2.new(0.5, 0.5),
                BackgroundTransparency = 1,
                Image = Icons[iconName],
                ImageColor3 = CONFIG.TEXT_SECONDARY,
                ZIndex = tabIconContainer.ZIndex + 1
            })
            tabIcon.Parent = tabIconContainer
        end
        
        -- Accent indicator (animated bar)
        local accentIndicator = CreateElement("Frame", {
            Name = "AccentIndicator",
            Size = UDim2.new(0, 3, 0.6, 0),
            Position = UDim2.new(0, 0, 0.2, 0),
            AnchorPoint = Vector2.new(0, 0),
            BackgroundColor3 = CONFIG.ACCENT_PRIMARY,
            BorderSizePixel = 0,
            Visible = false,
            ZIndex = tabButton.ZIndex + 2
        })
        accentIndicator.Parent = tabButton
        AddCorner(accentIndicator, UDim.new(0, 2))
        
        -- Hover effects
        tabButton.MouseEnter:Connect(function()
            if not accentIndicator.Visible then
                CreateQuickTween(tabButton, CONFIG.DURATION_FAST, {
                    BackgroundTransparency = 0.6
                }):Play()
                CreateQuickTween(tabLabel, CONFIG.DURATION_FAST, {
                    TextColor3 = CONFIG.TEXT_PRIMARY
                }):Play()
                if tabIcon then
                    CreateQuickTween(tabIcon, CONFIG.DURATION_FAST, {
                        ImageColor3 = CONFIG.TEXT_PRIMARY
                    }):Play()
                end
            end
        end)
        
        tabButton.MouseLeave:Connect(function()
            if not accentIndicator.Visible then
                CreateQuickTween(tabButton, CONFIG.DURATION_FAST, {
                    BackgroundTransparency = 1
                }):Play()
                CreateQuickTween(tabLabel, CONFIG.DURATION_FAST, {
                    TextColor3 = CONFIG.TEXT_SECONDARY
                }):Play()
                if tabIcon then
                    CreateQuickTween(tabIcon, CONFIG.DURATION_FAST, {
                        ImageColor3 = CONFIG.TEXT_SECONDARY
                    }):Play()
                end
            end
        end)
        
        -- Tab content container
        local tabContent = CreateElement("Frame", {
            Name = "TabContent_" .. tabName,
            Size = UDim2.new(1, -Scale(40), 1, -Scale(40)),
            Position = UDim2.new(0, Scale(20), 0, Scale(20)),
            BackgroundTransparency = 1,
            BorderSizePixel = 0,
            Visible = false,
            ZIndex = 5
        })
        tabContent.Parent = contentArea
        tabContent.ClipsDescendants = true
        
        local contentLayout = CreateElement("UIListLayout", {
            SortOrder = Enum.SortOrder.LayoutOrder,
            Padding = UDim.new(0, Scale(10))
        })
        contentLayout.Parent = tabContent
        
        local function updateCanvasSize()
            local absoluteContentSize = contentLayout.AbsoluteContentSize
            contentArea.CanvasSize = UDim2.new(0, 0, 0, absoluteContentSize.Y + Scale(40))
        end
        
        contentLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(updateCanvasSize)
        
        WindowInstances[window].Tabs[tabName] = {
            Button = tabButton,
            Content = tabContent,
            Elements = {}
        }
        
        -- Tab click handler
        tabButton.MouseButton1Click:Connect(function()
            -- Deactivate all other tabs
            for _, otherTab in pairs(WindowInstances[window].Tabs) do
                if otherTab.Content ~= tabContent then
                    otherTab.Content.Visible = false
                    
                    CreateQuickTween(otherTab.Button, CONFIG.DURATION_FAST, {
                        BackgroundTransparency = 1
                    }):Play()
                    
                    local otherLabel = otherTab.Button:FindFirstChild("TabLabel")
                    if otherLabel then
                        CreateQuickTween(otherLabel, CONFIG.DURATION_FAST, {
                            TextColor3 = CONFIG.TEXT_SECONDARY
                        }):Play()
                    end
                    
                    local otherIconContainer = otherTab.Button:FindFirstChild("IconContainer")
                    if otherIconContainer then
                        CreateQuickTween(otherIconContainer, CONFIG.DURATION_FAST, {
                            BackgroundTransparency = 1
                        }):Play()
                        local otherIcon = otherIconContainer:FindFirstChild("TabIcon")
                        if otherIcon then
                            CreateQuickTween(otherIcon, CONFIG.DURATION_FAST, {
                                ImageColor3 = CONFIG.TEXT_SECONDARY
                            }):Play()
                        end
                    end
                    
                    local otherIndicator = otherTab.Button:FindFirstChild("AccentIndicator")
                    if otherIndicator then
                        otherIndicator.Visible = false
                    end
                end
            end
            
            -- Activate this tab
            tabContent.Visible = true
            accentIndicator.Visible = true
            
            CreateSpringTween(tabButton, CONFIG.DURATION_NORMAL, {
                BackgroundTransparency = 0.5
            }):Play()
            
            CreateQuickTween(tabLabel, CONFIG.DURATION_FAST, {
                TextColor3 = CONFIG.TEXT_PRIMARY
            }):Play()
            
            CreateQuickTween(tabIconContainer, CONFIG.DURATION_FAST, {
                BackgroundTransparency = 0.85
            }):Play()
            
            if tabIcon then
                CreateQuickTween(tabIcon, CONFIG.DURATION_FAST, {
                    ImageColor3 = CONFIG.ACCENT_PRIMARY
                }):Play()
            end
            
            task.wait()
            updateCanvasSize()
        end)
        
        -- ════════════════════════════════════════════════════════════
        -- COMPONENT: BUTTON
        -- ════════════════════════════════════════════════════════════
        function tab:CreateButton(options)
            local buttonName = options.Name or "Button"
            local callback = options.Callback or function() end
            
            local button = CreateElement("TextButton", {
                Name = "Button_" .. buttonName,
                Size = UDim2.new(1, 0, 0, Scale(44)),
                BackgroundColor3 = CONFIG.ACCENT_PRIMARY,
                BorderSizePixel = 0,
                Text = buttonName,
                TextColor3 = CONFIG.TEXT_PRIMARY,
                TextSize = ScaleFont(14),
                Font = Enum.Font.GothamBold,
                AutoButtonColor = false,
                ClipsDescendants = true
            })
            button.Parent = tabContent
            
            AddCorner(button, CONFIG.RADIUS_MD)
            AddGradient(button, 180)
            
            -- Hover and click effects
            button.MouseEnter:Connect(function()
                CreateQuickTween(button, CONFIG.DURATION_FAST, {
                    BackgroundColor3 = CONFIG.ACCENT_HOVER
                }):Play()
            end)
            
            button.MouseLeave:Connect(function()
                CreateQuickTween(button, CONFIG.DURATION_FAST, {
                    BackgroundColor3 = CONFIG.ACCENT_PRIMARY
                }):Play()
            end)
            
            button.MouseButton1Down:Connect(function()
                CreateQuickTween(button, CONFIG.DURATION_INSTANT, {
                    BackgroundColor3 = CONFIG.ACCENT_ACTIVE,
                    Size = UDim2.new(1, -4, 0, Scale(42))
                }):Play()
            end)
            
            button.MouseButton1Up:Connect(function()
                CreateSpringTween(button, CONFIG.DURATION_FAST, {
                    BackgroundColor3 = CONFIG.ACCENT_HOVER,
                    Size = UDim2.new(1, 0, 0, Scale(44))
                }):Play()
            end)
            
            button.MouseButton1Click:Connect(function(x, y)
                -- Ripple effect
                local relativeX = (x or 0) - button.AbsolutePosition.X
                local relativeY = (y or 0) - button.AbsolutePosition.Y
                CreateRipple(button, UDim2.new(0, relativeX, 0, relativeY), CONFIG.TEXT_PRIMARY)
                
                callback()
            end)
            
            task.wait()
            updateCanvasSize()
            
            local element = {}
            function element:Set(newName)
                button.Text = newName
            end
            return element
        end
        
        -- ════════════════════════════════════════════════════════════
        -- COMPONENT: SECTION DIVIDER
        -- ════════════════════════════════════════════════════════════
        function tab:CreateSection(title)
            local sectionFrame = CreateElement("Frame", {
                Name = "Section_" .. (title or ""),
                Size = UDim2.new(1, 0, 0, Scale(32)),
                BackgroundTransparency = 1,
                BorderSizePixel = 0
            })
            sectionFrame.Parent = tabContent
            
            local leftLine = CreateElement("Frame", {
                Name = "LeftLine",
                Size = UDim2.new(0.25, -Scale(8), 0, 1),
                Position = UDim2.new(0, 0, 0.5, 0),
                BackgroundColor3 = CONFIG.BORDER_SUBTLE,
                BorderSizePixel = 0
            })
            leftLine.Parent = sectionFrame
            
            local titleLabel = CreateElement("TextLabel", {
                Name = "Title",
                Size = UDim2.new(0.5, 0, 1, 0),
                Position = UDim2.new(0.25, 0, 0, 0),
                BackgroundTransparency = 1,
                Text = string.upper(title or ""),
                TextColor3 = CONFIG.TEXT_MUTED,
                TextSize = ScaleFont(11),
                Font = Enum.Font.GothamBold,
                TextXAlignment = Enum.TextXAlignment.Center,
                TextYAlignment = Enum.TextYAlignment.Center
            })
            titleLabel.Parent = sectionFrame
            
            local rightLine = CreateElement("Frame", {
                Name = "RightLine",
                Size = UDim2.new(0.25, -Scale(8), 0, 1),
                Position = UDim2.new(0.75, Scale(8), 0.5, 0),
                BackgroundColor3 = CONFIG.BORDER_SUBTLE,
                BorderSizePixel = 0
            })
            rightLine.Parent = sectionFrame
            
            task.wait()
            updateCanvasSize()
            
            local element = {}
            function element:Set(newTitle)
                if newTitle then
                    titleLabel.Text = string.upper(newTitle)
                end
            end
            return element
        end
        
        -- ════════════════════════════════════════════════════════════
        -- COMPONENT: LABEL
        -- ════════════════════════════════════════════════════════════
        function tab:CreateLabel(text, color, ignoreTheme)
            local labelText = text or "Label"
            local textColor = color or (ignoreTheme and Color3.fromRGB(255, 255, 255) or CONFIG.TEXT_PRIMARY)
            
            local label = CreateElement("TextLabel", {
                Name = "Label_" .. labelText,
                Size = UDim2.new(1, 0, 0, Scale(24)),
                BackgroundTransparency = 1,
                Text = labelText,
                TextColor3 = textColor,
                TextSize = ScaleFont(14),
                Font = Enum.Font.GothamMedium,
                TextXAlignment = Enum.TextXAlignment.Left,
                TextYAlignment = Enum.TextYAlignment.Center
            })
            label.Parent = tabContent
            
            task.wait()
            updateCanvasSize()
            
            local element = {}
            function element:Set(newText, newColor)
                if newText then label.Text = newText end
                if newColor then label.TextColor3 = newColor end
            end
            return element
        end
        
        -- ════════════════════════════════════════════════════════════
        -- COMPONENT: PARAGRAPH
        -- ════════════════════════════════════════════════════════════
        function tab:CreateParagraph(initialData)
            initialData = initialData or {}
            local title = initialData.Title or ""
            local content = initialData.Content or ""
            
            local paragraphFrame = CreateElement("Frame", {
                Name = "ParagraphFrame",
                Size = UDim2.new(1, 0, 0, 0),
                BackgroundColor3 = CONFIG.SURFACE_3,
                BorderSizePixel = 0
            })
            paragraphFrame.Parent = tabContent
            AddCorner(paragraphFrame, CONFIG.RADIUS_MD)
            AddStroke(paragraphFrame, 1, CONFIG.BORDER_SUBTLE, 0.5)
            
            AddPadding(paragraphFrame, Scale(14), Scale(16), Scale(14), Scale(16))
            
            local titleLabel = CreateElement("TextLabel", {
                Name = "Title",
                Size = UDim2.new(1, 0, 0, Scale(20)),
                Position = UDim2.new(0, 0, 0, 0),
                BackgroundTransparency = 1,
                Text = title,
                TextColor3 = CONFIG.TEXT_PRIMARY,
                TextSize = ScaleFont(15),
                Font = Enum.Font.GothamBold,
                TextXAlignment = Enum.TextXAlignment.Left
            })
            titleLabel.Parent = paragraphFrame
            
            local contentLabel = CreateElement("TextLabel", {
                Name = "Content",
                Size = UDim2.new(1, 0, 0, 0),
                Position = UDim2.new(0, 0, 0, Scale(26)),
                BackgroundTransparency = 1,
                Text = content,
                TextColor3 = CONFIG.TEXT_SECONDARY,
                TextSize = ScaleFont(13),
                Font = Enum.Font.GothamMedium,
                TextWrapped = true,
                TextXAlignment = Enum.TextXAlignment.Left,
                TextYAlignment = Enum.TextYAlignment.Top
            })
            contentLabel.Parent = paragraphFrame
            
            local function updateParagraphSize()
                local contentSize = contentLabel.TextBounds
                contentLabel.Size = UDim2.new(1, 0, 0, contentSize.Y)
                paragraphFrame.Size = UDim2.new(1, 0, 0, contentSize.Y + Scale(54))
                task.wait()
                updateCanvasSize()
            end
            
            contentLabel:GetPropertyChangedSignal("Text"):Connect(updateParagraphSize)
            task.spawn(updateParagraphSize)
            
            local element = {}
            function element:Set(data)
                if data.Title ~= nil then titleLabel.Text = data.Title end
                if data.Content ~= nil then contentLabel.Text = data.Content end
            end
            return element
        end
        
        -- ════════════════════════════════════════════════════════════
        -- COMPONENT: TOGGLE (Modern Pill Switch)
        -- ════════════════════════════════════════════════════════════
        function tab:CreateToggle(options)
            local toggleName = options.Name or "Toggle"
            local currentValue = options.CurrentValue or false
            local flag = options.Flag or toggleName
            local callback = options.Callback or function() end
            local isLocked = options.IsLocked or false
            
            local toggleFrame = CreateElement("Frame", {
                Name = "ToggleFrame_" .. toggleName,
                Size = UDim2.new(1, 0, 0, Scale(50)),
                BackgroundColor3 = CONFIG.SURFACE_3,
                BorderSizePixel = 0
            })
            toggleFrame.Parent = tabContent
            
            AddCorner(toggleFrame, CONFIG.RADIUS_MD)
            AddStroke(toggleFrame, 1, CONFIG.BORDER_SUBTLE, 0.5)
            
            local label = CreateElement("TextLabel", {
                Name = "Label",
                Size = UDim2.new(1, -Scale(80), 1, 0),
                Position = UDim2.new(0, Scale(16), 0, 0),
                BackgroundTransparency = 1,
                Text = toggleName,
                TextColor3 = CONFIG.TEXT_PRIMARY,
                TextSize = ScaleFont(14),
                Font = Enum.Font.GothamMedium,
                TextXAlignment = Enum.TextXAlignment.Left
            })
            label.Parent = toggleFrame
            
            -- Modern pill toggle
            local toggleButton = CreateElement("TextButton", {
                Name = "ToggleButton",
                Size = ScaleUDim2(UDim2.new(0, 52, 0, 28)),
                Position = UDim2.new(1, -Scale(68), 0.5, -Scale(14)),
                BackgroundColor3 = CONFIG.SURFACE_4,
                BorderSizePixel = 0,
                Text = "",
                AutoButtonColor = false
            })
            toggleButton.Parent = toggleFrame
            
            AddCorner(toggleButton, UDim.new(0, Scale(14)))
            local toggleStroke = AddStroke(toggleButton, 1, CONFIG.BORDER_DEFAULT, 0.3)
            
            -- Inner shadow for depth
            local innerShadow = CreateElement("Frame", {
                Name = "InnerShadow",
                Size = UDim2.new(1, -2, 1, -2),
                Position = UDim2.new(0, 1, 0, 1),
                BackgroundColor3 = CONFIG.SURFACE_0,
                BackgroundTransparency = 0.8,
                BorderSizePixel = 0,
                ZIndex = toggleButton.ZIndex + 1
            })
            innerShadow.Parent = toggleButton
            AddCorner(innerShadow, UDim.new(0, Scale(13)))
            
            -- Toggle indicator (the moving circle)
            local toggleIndicator = CreateElement("Frame", {
                Name = "Indicator",
                Size = ScaleUDim2(UDim2.new(0, 22, 0, 22)),
                Position = UDim2.new(0, Scale(3), 0.5, -Scale(11)),
                BackgroundColor3 = CONFIG.TEXT_PRIMARY,
                BorderSizePixel = 0,
                ZIndex = toggleButton.ZIndex + 2
            })
            toggleIndicator.Parent = toggleButton
            AddCorner(toggleIndicator, CONFIG.RADIUS_FULL)
            
            -- Subtle shadow on indicator
            local indicatorShadow = CreateElement("Frame", {
                Name = "IndicatorShadow",
                Size = UDim2.new(1, 4, 1, 4),
                Position = UDim2.new(0.5, 0, 0.5, 1),
                AnchorPoint = Vector2.new(0.5, 0.5),
                BackgroundColor3 = CONFIG.SHADOW_COLOR,
                BackgroundTransparency = 0.7,
                BorderSizePixel = 0,
                ZIndex = toggleIndicator.ZIndex - 1
            })
            indicatorShadow.Parent = toggleIndicator
            AddCorner(indicatorShadow, CONFIG.RADIUS_FULL)
            
            ToggleStates[flag] = currentValue
            TrackToggle(callback, window, toggleName)
            
            local function updateToggle(enabled)
                if enabled then
                    CreateSpringTween(toggleButton, CONFIG.DURATION_NORMAL, {
                        BackgroundColor3 = isLocked and CONFIG.TEXT_MUTED or CONFIG.ACCENT_PRIMARY
                    }):Play()
                    CreateSpringTween(toggleIndicator, CONFIG.DURATION_NORMAL, {
                        Position = UDim2.new(0, Scale(27), 0.5, -Scale(11)),
                        BackgroundColor3 = CONFIG.TEXT_PRIMARY
                    }):Play()
                    CreateQuickTween(toggleStroke, CONFIG.DURATION_FAST, {
                        Color = CONFIG.ACCENT_PRIMARY,
                        Transparency = 0.5
                    }):Play()
                    CreateQuickTween(innerShadow, CONFIG.DURATION_FAST, {
                        BackgroundTransparency = 1
                    }):Play()
                else
                    CreateSpringTween(toggleButton, CONFIG.DURATION_NORMAL, {
                        BackgroundColor3 = isLocked and Color3.fromRGB(40, 40, 48) or CONFIG.SURFACE_4
                    }):Play()
                    CreateSpringTween(toggleIndicator, CONFIG.DURATION_NORMAL, {
                        Position = UDim2.new(0, Scale(3), 0.5, -Scale(11)),
                        BackgroundColor3 = isLocked and CONFIG.TEXT_MUTED or CONFIG.TEXT_PRIMARY
                    }):Play()
                    CreateQuickTween(toggleStroke, CONFIG.DURATION_FAST, {
                        Color = CONFIG.BORDER_DEFAULT,
                        Transparency = 0.3
                    }):Play()
                    CreateQuickTween(innerShadow, CONFIG.DURATION_FAST, {
                        BackgroundTransparency = 0.8
                    }):Play()
                end
            end
            
            updateToggle(currentValue)
            
            toggleButton.MouseButton1Click:Connect(function()
                if not isLocked then
                    currentValue = not currentValue
                    ToggleStates[flag] = currentValue
                    updateToggle(currentValue)
                    callback(currentValue)
                end
            end)
            
            -- Hover effect on whole frame
            toggleFrame.MouseEnter:Connect(function()
                CreateQuickTween(toggleFrame, CONFIG.DURATION_FAST, {
                    BackgroundColor3 = CONFIG.SURFACE_HOVER
                }):Play()
            end)
            
            toggleFrame.MouseLeave:Connect(function()
                CreateQuickTween(toggleFrame, CONFIG.DURATION_FAST, {
                    BackgroundColor3 = CONFIG.SURFACE_3
                }):Play()
            end)
            
            task.wait()
            updateCanvasSize()
            
            local element = {}
            function element:Set(value, noCallback)
                if value ~= currentValue then
                    currentValue = value
                    ToggleStates[flag] = value
                    updateToggle(value)
                    if not noCallback then
                        callback(value)
                    end
                end
            end
            
            function element:Lock()
                isLocked = true
                updateToggle(currentValue)
            end
            
            function element:Unlock()
                isLocked = false
                updateToggle(currentValue)
            end
            
            function element:IsLocked()
                return isLocked
            end
            
            return element
        end
        
        -- ════════════════════════════════════════════════════════════
        -- COMPONENT: SLIDER (Modern Track Design)
        -- ════════════════════════════════════════════════════════════
        function tab:CreateSlider(options)
            local sliderName = options.Name or "Slider"
            local range = options.Range or {0, 100}
            local increment = options.Increment or 1
            local suffix = options.Suffix or ""
            local currentValue = options.CurrentValue or range[1]
            local flag = options.Flag or sliderName
            local callback = options.Callback or function() end
            
            local sliderFrame = CreateElement("Frame", {
                Name = "SliderFrame_" .. sliderName,
                Size = UDim2.new(1, 0, 0, Scale(68)),
                BackgroundColor3 = CONFIG.SURFACE_3,
                BorderSizePixel = 0
            })
            sliderFrame.Parent = tabContent
            
            AddCorner(sliderFrame, CONFIG.RADIUS_MD)
            AddStroke(sliderFrame, 1, CONFIG.BORDER_SUBTLE, 0.5)
            
            local label = CreateElement("TextLabel", {
                Name = "Label",
                Size = UDim2.new(0.65, -Scale(16), 0, Scale(20)),
                Position = UDim2.new(0, Scale(16), 0, Scale(12)),
                BackgroundTransparency = 1,
                Text = sliderName,
                TextColor3 = CONFIG.TEXT_PRIMARY,
                TextSize = ScaleFont(14),
                Font = Enum.Font.GothamMedium,
                TextXAlignment = Enum.TextXAlignment.Left
            })
            label.Parent = sliderFrame
            
            -- Value badge
            local valueBadge = CreateElement("Frame", {
                Name = "ValueBadge",
                Size = ScaleUDim2(UDim2.new(0, 56, 0, 24)),
                Position = UDim2.new(1, -Scale(72), 0, Scale(10)),
                BackgroundColor3 = CONFIG.ACCENT_PRIMARY,
                BackgroundTransparency = 0.85,
                BorderSizePixel = 0
            })
            valueBadge.Parent = sliderFrame
            AddCorner(valueBadge, CONFIG.RADIUS_SM)
            
            local valueLabel = CreateElement("TextLabel", {
                Name = "ValueLabel",
                Size = UDim2.new(1, 0, 1, 0),
                BackgroundTransparency = 1,
                Text = currentValue .. suffix,
                TextColor3 = CONFIG.ACCENT_PRIMARY,
                TextSize = ScaleFont(12),
                Font = Enum.Font.GothamBold
            })
            valueLabel.Parent = valueBadge
            
            -- Modern slider track
            local sliderTrack = CreateElement("Frame", {
                Name = "SliderTrack",
                Size = UDim2.new(1, -Scale(32), 0, Scale(8)),
                Position = UDim2.new(0, Scale(16), 0, Scale(46)),
                BackgroundColor3 = CONFIG.SURFACE_4,
                BorderSizePixel = 0
            })
            sliderTrack.Parent = sliderFrame
            AddCorner(sliderTrack, UDim.new(0, Scale(4)))
            
            -- Active fill with glow
            local sliderFill = CreateElement("Frame", {
                Name = "SliderFill",
                Size = UDim2.new(0, 0, 1, 0),
                Position = UDim2.new(0, 0, 0, 0),
                BackgroundColor3 = CONFIG.ACCENT_PRIMARY,
                BorderSizePixel = 0
            })
            sliderFill.Parent = sliderTrack
            AddCorner(sliderFill, UDim.new(0, Scale(4)))
            
            -- Fill glow
            local fillGlow = CreateElement("Frame", {
                Name = "FillGlow",
                Size = UDim2.new(1, 0, 1, 4),
                Position = UDim2.new(0, 0, 0.5, 0),
                AnchorPoint = Vector2.new(0, 0.5),
                BackgroundColor3 = CONFIG.ACCENT_GLOW,
                BackgroundTransparency = 0.7,
                BorderSizePixel = 0,
                ZIndex = sliderFill.ZIndex - 1
            })
            fillGlow.Parent = sliderFill
            AddCorner(fillGlow, UDim.new(0, Scale(4)))
            
            -- Slider thumb
            local sliderThumb = CreateElement("TextButton", {
                Name = "SliderThumb",
                Size = ScaleUDim2(UDim2.new(0, 20, 0, 20)),
                Position = UDim2.new(0, -Scale(10), 0.5, -Scale(10)),
                BackgroundColor3 = CONFIG.TEXT_PRIMARY,
                BorderSizePixel = 0,
                Text = "",
                AutoButtonColor = false,
                ZIndex = sliderTrack.ZIndex + 2
            })
            sliderThumb.Parent = sliderTrack
            AddCorner(sliderThumb, CONFIG.RADIUS_FULL)
            
            -- Thumb glow ring
            local thumbGlow = CreateElement("Frame", {
                Name = "ThumbGlow",
                Size = UDim2.new(1, 10, 1, 10),
                Position = UDim2.new(0.5, 0, 0.5, 0),
                AnchorPoint = Vector2.new(0.5, 0.5),
                BackgroundColor3 = CONFIG.ACCENT_PRIMARY,
                BackgroundTransparency = 0.75,
                BorderSizePixel = 0,
                ZIndex = sliderThumb.ZIndex - 1
            })
            thumbGlow.Parent = sliderThumb
            AddCorner(thumbGlow, CONFIG.RADIUS_FULL)
            
            ToggleStates[flag] = currentValue
            
            local function updateSlider(value, animate)
                value = math.max(range[1], math.min(range[2], value))
                value = math.floor(value / increment + 0.5) * increment
                
                local percentage = (value - range[1]) / (range[2] - range[1])
                local duration = animate and CONFIG.DURATION_INSTANT or 0
                
                if animate then
                    CreateQuickTween(sliderFill, duration, {
                        Size = UDim2.new(percentage, 0, 1, 0)
                    }):Play()
                    CreateQuickTween(sliderThumb, duration, {
                        Position = UDim2.new(percentage, -Scale(10), 0.5, -Scale(10))
                    }):Play()
                else
                    sliderFill.Size = UDim2.new(percentage, 0, 1, 0)
                    sliderThumb.Position = UDim2.new(percentage, -Scale(10), 0.5, -Scale(10))
                end
                
                valueLabel.Text = value .. suffix
                ToggleStates[flag] = value
                callback(value)
            end
            
            updateSlider(currentValue, false)
            
            local isDragging = false
            
            sliderThumb.MouseButton1Down:Connect(function()
                isDragging = true
                CreateSpringTween(sliderThumb, CONFIG.DURATION_FAST, {
                    Size = ScaleUDim2(UDim2.new(0, 24, 0, 24))
                }):Play()
                CreateQuickTween(thumbGlow, CONFIG.DURATION_FAST, {
                    BackgroundTransparency = 0.5,
                    Size = UDim2.new(1, 16, 1, 16)
                }):Play()
            end)
            
            local dragConnection = UserInputService.InputChanged:Connect(function(input)
                if isDragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
                    local relativeX = input.Position.X - sliderTrack.AbsolutePosition.X
                    local percentage = math.max(0, math.min(1, relativeX / sliderTrack.AbsoluteSize.X))
                    local value = range[1] + (range[2] - range[1]) * percentage
                    updateSlider(value, true)
                end
            end)
            
            local dragEndConnection = UserInputService.InputEnded:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                    if isDragging then
                        isDragging = false
                        CreateSpringTween(sliderThumb, CONFIG.DURATION_FAST, {
                            Size = ScaleUDim2(UDim2.new(0, 20, 0, 20))
                        }):Play()
                        CreateQuickTween(thumbGlow, CONFIG.DURATION_FAST, {
                            BackgroundTransparency = 0.75,
                            Size = UDim2.new(1, 10, 1, 10)
                        }):Play()
                    end
                end
            end)
            
            TrackConnection(dragConnection, window)
            TrackConnection(dragEndConnection, window)
            
            -- Click on track to set value
            sliderTrack.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                    local relativeX = input.Position.X - sliderTrack.AbsolutePosition.X
                    local percentage = math.max(0, math.min(1, relativeX / sliderTrack.AbsoluteSize.X))
                    local value = range[1] + (range[2] - range[1]) * percentage
                    updateSlider(value, true)
                    isDragging = true
                end
            end)
            
            task.wait()
            updateCanvasSize()
            
            local element = {}
            function element:Set(value)
                updateSlider(value, true)
            end
            return element
        end
        
        -- ════════════════════════════════════════════════════════════
        -- COMPONENT: DROPDOWN (Modern Select)
        -- ════════════════════════════════════════════════════════════
        function tab:CreateDropdown(options)
            local dropdownName = options.Name or "Dropdown"
            local optionsList = options.Options or {}
            local currentOption = options.CurrentOption or nil
            local multipleOptions = options.MultipleOptions or false
            local flag = options.Flag or dropdownName
            local callback = options.Callback or function() end
            
            local dropdownFrame = CreateElement("Frame", {
                Name = "DropdownFrame_" .. dropdownName,
                Size = UDim2.new(1, 0, 0, Scale(70)),
                BackgroundColor3 = CONFIG.SURFACE_3,
                BorderSizePixel = 0,
                ClipsDescendants = false,
                ZIndex = 30
            })
            dropdownFrame.Parent = tabContent
            
            AddCorner(dropdownFrame, CONFIG.RADIUS_MD)
            AddStroke(dropdownFrame, 1, CONFIG.BORDER_SUBTLE, 0.5)
            
            local label = CreateElement("TextLabel", {
                Name = "Label",
                Size = UDim2.new(1, -Scale(32), 0, Scale(20)),
                Position = UDim2.new(0, Scale(16), 0, Scale(10)),
                BackgroundTransparency = 1,
                Text = dropdownName,
                TextColor3 = CONFIG.TEXT_PRIMARY,
                TextSize = ScaleFont(14),
                Font = Enum.Font.GothamMedium,
                TextXAlignment = Enum.TextXAlignment.Left,
                ZIndex = 31
            })
            label.Parent = dropdownFrame
            
            -- Dropdown button
            local dropdownButton = CreateElement("TextButton", {
                Name = "DropdownButton",
                Size = UDim2.new(1, -Scale(32), 0, Scale(36)),
                Position = UDim2.new(0, Scale(16), 0, Scale(30)),
                BackgroundColor3 = CONFIG.SURFACE_4,
                BorderSizePixel = 0,
                Text = "",
                AutoButtonColor = false,
                ZIndex = 31
            })
            dropdownButton.Parent = dropdownFrame
            AddCorner(dropdownButton, CONFIG.RADIUS_SM)
            local buttonStroke = AddStroke(dropdownButton, 1, CONFIG.BORDER_DEFAULT, 0.3)
            
            local selectedText = CreateElement("TextLabel", {
                Name = "SelectedText",
                Size = UDim2.new(1, -Scale(36), 1, 0),
                Position = UDim2.new(0, Scale(12), 0, 0),
                BackgroundTransparency = 1,
                Text = currentOption or "Select option...",
                TextColor3 = currentOption and CONFIG.TEXT_PRIMARY or CONFIG.TEXT_MUTED,
                TextSize = ScaleFont(13),
                Font = Enum.Font.GothamMedium,
                TextXAlignment = Enum.TextXAlignment.Left,
                TextTruncate = Enum.TextTruncate.AtEnd,
                ZIndex = 32
            })
            selectedText.Parent = dropdownButton
            
            -- Chevron icon
            local chevronContainer = CreateElement("Frame", {
                Name = "ChevronContainer",
                Size = ScaleUDim2(UDim2.new(0, 24, 0, 24)),
                Position = UDim2.new(1, -Scale(30), 0.5, -Scale(12)),
                BackgroundTransparency = 1,
                ZIndex = 32
            })
            chevronContainer.Parent = dropdownButton
            
            local chevron = nil
            if Icons["ChevronDown"] then
                chevron = CreateElement("ImageLabel", {
                    Name = "Chevron",
                    Size = UDim2.new(1, 0, 1, 0),
                    BackgroundTransparency = 1,
                    Image = Icons["ChevronDown"],
                    ImageColor3 = CONFIG.TEXT_SECONDARY,
                    Rotation = 0,
                    ZIndex = 33
                })
                chevron.Parent = chevronContainer
            else
                chevron = CreateElement("TextLabel", {
                    Name = "Chevron",
                    Size = UDim2.new(1, 0, 1, 0),
                    BackgroundTransparency = 1,
                    Text = "v",
                    TextColor3 = CONFIG.TEXT_SECONDARY,
                    TextSize = ScaleFont(14),
                    Font = Enum.Font.GothamBold,
                    Rotation = 0,
                    ZIndex = 33
                })
                chevron.Parent = chevronContainer
            end
            
            -- Options list (scrolling frame)
            local optionsListFrame = CreateElement("ScrollingFrame", {
                Name = "OptionsList",
                Size = UDim2.new(1, -Scale(32), 0, 0),
                Position = UDim2.new(0, Scale(16), 0, Scale(68)),
                BackgroundColor3 = CONFIG.SURFACE_3,
                BorderSizePixel = 0,
                Visible = false,
                ScrollBarThickness = Scale(3),
                ScrollBarImageColor3 = CONFIG.ACCENT_PRIMARY,
                ScrollBarImageTransparency = 0.5,
                ZIndex = 50,
                ClipsDescendants = true
            })
            optionsListFrame.Parent = dropdownFrame
            
            AddCorner(optionsListFrame, CONFIG.RADIUS_SM)
            AddStroke(optionsListFrame, 1, CONFIG.BORDER_DEFAULT, 0.3)
            AddPadding(optionsListFrame, Scale(6), Scale(6), Scale(6), Scale(6))
            
            local optionsLayout = CreateElement("UIListLayout", {
                SortOrder = Enum.SortOrder.LayoutOrder,
                Padding = UDim.new(0, Scale(4))
            })
            optionsLayout.Parent = optionsListFrame
            
            ToggleStates[flag] = currentOption
            
            local isOpen = false
            local selectedOptions
            if multipleOptions then
                selectedOptions = {}
                if currentOption ~= nil then
                    table.insert(selectedOptions, currentOption)
                end
            else
                selectedOptions = currentOption
            end
            
            local outsideConn = nil
            
            local function updateDropdownText()
                if multipleOptions then
                    local text = #selectedOptions > 0 and table.concat(selectedOptions, ", ") or "Select options..."
                    selectedText.Text = text
                    selectedText.TextColor3 = #selectedOptions > 0 and CONFIG.TEXT_PRIMARY or CONFIG.TEXT_MUTED
                else
                    selectedText.Text = selectedOptions or "Select option..."
                    selectedText.TextColor3 = selectedOptions and CONFIG.TEXT_PRIMARY or CONFIG.TEXT_MUTED
                end
            end
            
            local function updateCanvasSizeDropdown()
                local contentY = optionsLayout.AbsoluteContentSize.Y + Scale(12)
                optionsListFrame.CanvasSize = UDim2.new(0, 0, 0, contentY)
                return math.min(contentY, Scale(160))
            end
            
            local function isPointInGui(guiObject, point)
                local pos = guiObject.AbsolutePosition
                local size = guiObject.AbsoluteSize
                return point.X >= pos.X and point.X <= (pos.X + size.X) and point.Y >= pos.Y and point.Y <= (pos.Y + size.Y)
            end
            
            local function setOpen(open)
                if isOpen == open then return end
                isOpen = open
                
                if outsideConn then
                    outsideConn:Disconnect()
                    outsideConn = nil
                end
                
                if isOpen then
                    local openHeight = updateCanvasSizeDropdown()
                    optionsListFrame.Visible = true
                    optionsListFrame.Size = UDim2.new(1, -Scale(32), 0, 0)
                    optionsListFrame.BackgroundTransparency = 1
                    
                    dropdownFrame.ZIndex = 100
                    optionsListFrame.ZIndex = 101
                    
                    CreateSpringTween(optionsListFrame, CONFIG.DURATION_NORMAL, {
                        Size = UDim2.new(1, -Scale(32), 0, openHeight),
                        BackgroundTransparency = 0
                    }):Play()
                    
                    CreateQuickTween(chevron, CONFIG.DURATION_FAST, {
                        Rotation = 180
                    }):Play()
                    
                    CreateQuickTween(buttonStroke, CONFIG.DURATION_FAST, {
                        Color = CONFIG.ACCENT_PRIMARY
                    }):Play()
                    
                    outsideConn = UserInputService.InputBegan:Connect(function(input, gameProcessed)
                        if gameProcessed then return end
                        if input.UserInputType ~= Enum.UserInputType.MouseButton1 then return end
                        local p = UserInputService:GetMouseLocation()
                        if not isPointInGui(dropdownFrame, p) and not isPointInGui(optionsListFrame, p) then
                            setOpen(false)
                        end
                    end)
                    TrackConnection(outsideConn, window)
                else
                    CreateSmoothTween(optionsListFrame, CONFIG.DURATION_FAST, {
                        Size = UDim2.new(1, -Scale(32), 0, 0),
                        BackgroundTransparency = 1
                    }):Play()
                    
                    CreateQuickTween(chevron, CONFIG.DURATION_FAST, {
                        Rotation = 0
                    }):Play()
                    
                    CreateQuickTween(buttonStroke, CONFIG.DURATION_FAST, {
                        Color = CONFIG.BORDER_DEFAULT
                    }):Play()
                    
                    task.delay(CONFIG.DURATION_FAST, function()
                        if not isOpen then
                            optionsListFrame.Visible = false
                            dropdownFrame.ZIndex = 30
                            optionsListFrame.ZIndex = 50
                        end
                    end)
                end
            end
            
            updateDropdownText()
            
            -- Create option buttons
            local function createOptionButton(i, option)
                local isSelected = multipleOptions and table.find(selectedOptions, option) or selectedOptions == option
                
                local optionButton = CreateElement("TextButton", {
                    Name = "Option_" .. i,
                    Size = UDim2.new(1, 0, 0, Scale(34)),
                    BackgroundColor3 = isSelected and CONFIG.ACCENT_PRIMARY or CONFIG.SURFACE_4,
                    BackgroundTransparency = isSelected and 0.85 or 0,
                    BorderSizePixel = 0,
                    Text = "",
                    AutoButtonColor = false,
                    ZIndex = 102
                })
                optionButton.Parent = optionsListFrame
                
                AddCorner(optionButton, CONFIG.RADIUS_SM)
                
                local optionLabel = CreateElement("TextLabel", {
                    Size = UDim2.new(1, -Scale(32), 1, 0),
                    Position = UDim2.new(0, Scale(12), 0, 0),
                    BackgroundTransparency = 1,
                    Text = option,
                    TextColor3 = isSelected and CONFIG.ACCENT_PRIMARY or CONFIG.TEXT_PRIMARY,
                    TextSize = ScaleFont(13),
                    Font = isSelected and Enum.Font.GothamBold or Enum.Font.GothamMedium,
                    TextXAlignment = Enum.TextXAlignment.Left,
                    ZIndex = 103
                })
                optionLabel.Parent = optionButton
                
                -- Checkmark
                local checkmark = nil
                if Icons["Check"] then
                    checkmark = CreateElement("ImageLabel", {
                        Size = ScaleUDim2(UDim2.new(0, 16, 0, 16)),
                        Position = UDim2.new(1, -Scale(28), 0.5, -Scale(8)),
                        BackgroundTransparency = 1,
                        Image = Icons["Check"],
                        ImageColor3 = CONFIG.ACCENT_PRIMARY,
                        Visible = isSelected,
                        ZIndex = 103
                    })
                    checkmark.Parent = optionButton
                else
                    checkmark = CreateElement("TextLabel", {
                        Size = ScaleUDim2(UDim2.new(0, 16, 0, 16)),
                        Position = UDim2.new(1, -Scale(28), 0.5, -Scale(8)),
                        BackgroundTransparency = 1,
                        Text = "✓",
                        TextColor3 = CONFIG.ACCENT_PRIMARY,
                        TextSize = ScaleFont(14),
                        Font = Enum.Font.GothamBold,
                        Visible = isSelected,
                        ZIndex = 103
                    })
                    checkmark.Parent = optionButton
                end
                
                local function updateOptionStyle(selected)
                    CreateQuickTween(optionButton, CONFIG.DURATION_FAST, {
                        BackgroundColor3 = selected and CONFIG.ACCENT_PRIMARY or CONFIG.SURFACE_4,
                        BackgroundTransparency = selected and 0.85 or 0
                    }):Play()
                    CreateQuickTween(optionLabel, CONFIG.DURATION_FAST, {
                        TextColor3 = selected and CONFIG.ACCENT_PRIMARY or CONFIG.TEXT_PRIMARY
                    }):Play()
                    optionLabel.Font = selected and Enum.Font.GothamBold or Enum.Font.GothamMedium
                    checkmark.Visible = selected
                end
                
                optionButton.MouseButton1Click:Connect(function()
                    if multipleOptions then
                        local index = table.find(selectedOptions, option)
                        if index then
                            table.remove(selectedOptions, index)
                            updateOptionStyle(false)
                        else
                            table.insert(selectedOptions, option)
                            updateOptionStyle(true)
                        end
                        updateDropdownText()
                    else
                        for _, child in pairs(optionsListFrame:GetChildren()) do
                            if child:IsA("TextButton") then
                                local childLabel = child:FindFirstChild("TextLabel")
                                local childCheck = child:FindFirstChildWhichIsA("ImageLabel") or child:FindFirstChildWhichIsA("TextLabel", true)
                                if childCheck and (childCheck.Text == "✓" or childCheck.Name == "ImageLabel") then
                                    childCheck.Visible = false
                                end
                                if childLabel then
                                    CreateQuickTween(child, CONFIG.DURATION_FAST, {
                                        BackgroundColor3 = CONFIG.SURFACE_4,
                                        BackgroundTransparency = 0
                                    }):Play()
                                    CreateQuickTween(childLabel, CONFIG.DURATION_FAST, {
                                        TextColor3 = CONFIG.TEXT_PRIMARY
                                    }):Play()
                                    childLabel.Font = Enum.Font.GothamMedium
                                end
                            end
                        end
                        
                        selectedOptions = option
                        updateOptionStyle(true)
                        updateDropdownText()
                        setOpen(false)
                    end
                    
                    ToggleStates[flag] = selectedOptions
                    callback(selectedOptions)
                end)
                
                optionButton.MouseEnter:Connect(function()
                    if not (multipleOptions and table.find(selectedOptions, option) or selectedOptions == option) then
                        CreateQuickTween(optionButton, CONFIG.DURATION_INSTANT, {
                            BackgroundColor3 = CONFIG.SURFACE_HOVER
                        }):Play()
                    end
                end)
                
                optionButton.MouseLeave:Connect(function()
                    local selected = multipleOptions and table.find(selectedOptions, option) or selectedOptions == option
                    if not selected then
                        CreateQuickTween(optionButton, CONFIG.DURATION_INSTANT, {
                            BackgroundColor3 = CONFIG.SURFACE_4
                        }):Play()
                    end
                end)
                
                return optionButton
            end
            
            for i, option in ipairs(optionsList) do
                createOptionButton(i, option)
            end
            
            updateCanvasSizeDropdown()
            
            dropdownButton.MouseEnter:Connect(function()
                if not isOpen then
                    CreateQuickTween(dropdownButton, CONFIG.DURATION_FAST, {
                        BackgroundColor3 = CONFIG.SURFACE_HOVER
                    }):Play()
                end
            end)
            
            dropdownButton.MouseLeave:Connect(function()
                if not isOpen then
                    CreateQuickTween(dropdownButton, CONFIG.DURATION_FAST, {
                        BackgroundColor3 = CONFIG.SURFACE_4
                    }):Play()
                end
            end)
            
            dropdownButton.MouseButton1Click:Connect(function()
                setOpen(not isOpen)
            end)
            
            task.wait()
            updateCanvasSize()
            
            local element = {}
            function element:Set(options)
                if multipleOptions then
                    selectedOptions = type(options) == "table" and options or {options}
                else
                    selectedOptions = type(options) == "table" and options[1] or options
                end
                updateDropdownText()
                ToggleStates[flag] = selectedOptions
            end
            
            function element:Refresh(newOptions)
                optionsList = newOptions
                for _, child in pairs(optionsListFrame:GetChildren()) do
                    if child:IsA("TextButton") then
                        child:Destroy()
                    end
                end
                for i, option in ipairs(optionsList) do
                    createOptionButton(i, option)
                end
                updateCanvasSizeDropdown()
            end
            
            return element
        end
        
        -- ════════════════════════════════════════════════════════════
        -- COMPONENT: INPUT FIELD
        -- ════════════════════════════════════════════════════════════
        function tab:CreateInput(options)
            local inputName = options.Name or "Input"
            local currentValue = options.CurrentValue or ""
            local placeholderText = options.PlaceholderText or "Enter text..."
            local removeTextAfterFocusLost = options.RemoveTextAfterFocusLost or false
            local flag = options.Flag or inputName
            local callback = options.Callback or function() end
            
            local inputFrame = CreateElement("Frame", {
                Name = "InputFrame_" .. inputName,
                Size = UDim2.new(1, 0, 0, Scale(74)),
                BackgroundColor3 = CONFIG.SURFACE_3,
                BorderSizePixel = 0
            })
            inputFrame.Parent = tabContent
            
            AddCorner(inputFrame, CONFIG.RADIUS_MD)
            AddStroke(inputFrame, 1, CONFIG.BORDER_SUBTLE, 0.5)
            
            local label = CreateElement("TextLabel", {
                Name = "Label",
                Size = UDim2.new(1, -Scale(32), 0, Scale(20)),
                Position = UDim2.new(0, Scale(16), 0, Scale(10)),
                BackgroundTransparency = 1,
                Text = inputName,
                TextColor3 = CONFIG.TEXT_PRIMARY,
                TextSize = ScaleFont(14),
                Font = Enum.Font.GothamMedium,
                TextXAlignment = Enum.TextXAlignment.Left
            })
            label.Parent = inputFrame
            
            local textBoxContainer = CreateElement("Frame", {
                Name = "TextBoxContainer",
                Size = UDim2.new(1, -Scale(32), 0, Scale(38)),
                Position = UDim2.new(0, Scale(16), 0, Scale(32)),
                BackgroundColor3 = CONFIG.SURFACE_4,
                BorderSizePixel = 0
            })
            textBoxContainer.Parent = inputFrame
            AddCorner(textBoxContainer, CONFIG.RADIUS_SM)
            local inputStroke = AddStroke(textBoxContainer, 1, CONFIG.BORDER_DEFAULT, 0.3)
            
            local textBox = CreateElement("TextBox", {
                Name = "TextBox",
                Size = UDim2.new(1, -Scale(24), 1, 0),
                Position = UDim2.new(0, Scale(12), 0, 0),
                BackgroundTransparency = 1,
                Text = currentValue,
                PlaceholderText = placeholderText,
                PlaceholderColor3 = CONFIG.TEXT_MUTED,
                TextColor3 = CONFIG.TEXT_PRIMARY,
                TextSize = ScaleFont(13),
                Font = Enum.Font.GothamMedium,
                TextXAlignment = Enum.TextXAlignment.Left,
                ClearTextOnFocus = false
            })
            textBox.Parent = textBoxContainer
            
            ToggleStates[flag] = currentValue
            
            textBox.Focused:Connect(function()
                CreateQuickTween(inputStroke, CONFIG.DURATION_FAST, {
                    Color = CONFIG.ACCENT_PRIMARY,
                    Transparency = 0,
                    Thickness = CONFIG.BORDER_WIDTH_FOCUS
                }):Play()
                CreateQuickTween(textBoxContainer, CONFIG.DURATION_FAST, {
                    BackgroundColor3 = CONFIG.SURFACE_HOVER
                }):Play()
            end)
            
            textBox.FocusLost:Connect(function(enterPressed)
                CreateQuickTween(inputStroke, CONFIG.DURATION_FAST, {
                    Color = CONFIG.BORDER_DEFAULT,
                    Transparency = 0.3,
                    Thickness = CONFIG.BORDER_WIDTH
                }):Play()
                CreateQuickTween(textBoxContainer, CONFIG.DURATION_FAST, {
                    BackgroundColor3 = CONFIG.SURFACE_4
                }):Play()
                
                local text = textBox.Text
                if removeTextAfterFocusLost then
                    textBox.Text = ""
                end
                ToggleStates[flag] = text
                callback(text)
            end)
            
            task.wait()
            updateCanvasSize()
            
            local element = {}
            function element:Set(text)
                textBox.Text = text
                ToggleStates[flag] = text
            end
            return element
        end
        
        -- Select first tab by default
        local tabCountCheck = 0
        for _ in pairs(WindowInstances[window].Tabs) do
            tabCountCheck = tabCountCheck + 1
        end
        
        if tabCountCheck == 1 then
            tabContent.Visible = true
            tabButton.BackgroundTransparency = 0.5
            tabLabel.TextColor3 = CONFIG.TEXT_PRIMARY
            
            CreateQuickTween(tabIconContainer, CONFIG.DURATION_FAST, {
                BackgroundTransparency = 0.85
            }):Play()
            
            if tabIcon then
                tabIcon.ImageColor3 = CONFIG.ACCENT_PRIMARY
            end
            
            accentIndicator.Visible = true
            
            task.wait()
            updateCanvasSize()
        end
        
        return tab
    end
    
    if onWindowCreated then
        onWindowCreated(window)
    end
    
    return window
end

-- ══════════════════════════════════════════════════════════════════════
-- KEY SYSTEM WINDOW
-- ══════════════════════════════════════════════════════════════════════
function VortexUI:ShowKeyWindow(callback, keySystemData)
    local CoreGui = game:GetService("CoreGui")
    
    local screenGui = CreateElement("ScreenGui", {
        Name = "VortexKeySystem",
        IgnoreGuiInset = true,
        ZIndexBehavior = Enum.ZIndexBehavior.Sibling,
        ResetOnSpawn = false
    })
    screenGui.Parent = CoreGui
    
    -- Dark overlay
    local overlay = CreateElement("Frame", {
        Name = "Overlay",
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundColor3 = CONFIG.SURFACE_0,
        BackgroundTransparency = 0.4,
        BorderSizePixel = 0
    })
    overlay.Parent = screenGui
    
    overlay.BackgroundTransparency = 1
    CreateSmoothTween(overlay, CONFIG.DURATION_NORMAL, {
        BackgroundTransparency = 0.4
    }):Play()
    
    -- Key window
    local keyWindow = CreateElement("Frame", {
        Name = "KeyWindow",
        Size = UDim2.new(0, Scale(340), 0, Scale(300)),
        Position = UDim2.new(0.5, -Scale(170), 0.5, -Scale(150)),
        BackgroundColor3 = CONFIG.SURFACE_2,
        BorderSizePixel = 0
    })
    keyWindow.Parent = screenGui
    
    AddCorner(keyWindow, CONFIG.RADIUS_XL)
    AddStroke(keyWindow, 1, CONFIG.BORDER_SUBTLE, 0.3)
    AddShadow(keyWindow, "xl")
    
    -- Entry animation
    keyWindow.Size = UDim2.new(0, 0, 0, 0)
    keyWindow.Position = UDim2.new(0.5, 0, 0.5, 0)
    keyWindow.BackgroundTransparency = 1
    
    CreateSpringTween(keyWindow, CONFIG.DURATION_SLOW, {
        Size = UDim2.new(0, Scale(340), 0, Scale(300)),
        Position = UDim2.new(0.5, -Scale(170), 0.5, -Scale(150)),
        BackgroundTransparency = 0
    }):Play()
    
    -- Accent header strip
    local headerAccent = CreateElement("Frame", {
        Name = "HeaderAccent",
        Size = UDim2.new(1, 0, 0, Scale(4)),
        Position = UDim2.new(0, 0, 0, 0),
        BackgroundColor3 = CONFIG.ACCENT_PRIMARY,
        BorderSizePixel = 0
    })
    headerAccent.Parent = keyWindow
    
    local accentCorner = AddCorner(headerAccent, CONFIG.RADIUS_XL)
    
    local accentCover = CreateElement("Frame", {
        Size = UDim2.new(1, 0, 0.5, 0),
        Position = UDim2.new(0, 0, 0.5, 0),
        BackgroundColor3 = CONFIG.ACCENT_PRIMARY,
        BorderSizePixel = 0
    })
    accentCover.Parent = headerAccent
    
    AddGradient(headerAccent, 0)
    
    -- Lock icon container
    local iconContainer = CreateElement("Frame", {
        Name = "IconContainer",
        Size = UDim2.new(0, Scale(56), 0, Scale(56)),
        Position = UDim2.new(0.5, -Scale(28), 0, Scale(28)),
        BackgroundColor3 = CONFIG.ACCENT_PRIMARY,
        BackgroundTransparency = 0.9,
        BorderSizePixel = 0
    })
    iconContainer.Parent = keyWindow
    AddCorner(iconContainer, CONFIG.RADIUS_FULL)
    
    local lockIcon = nil
    if Icons["Lock"] then
        lockIcon = CreateElement("ImageLabel", {
            Size = UDim2.new(0, Scale(28), 0, Scale(28)),
            Position = UDim2.new(0.5, 0, 0.5, 0),
            AnchorPoint = Vector2.new(0.5, 0.5),
            BackgroundTransparency = 1,
            Image = Icons["Lock"],
            ImageColor3 = CONFIG.ACCENT_PRIMARY
        })
        lockIcon.Parent = iconContainer
    else
        lockIcon = CreateElement("TextLabel", {
            Size = UDim2.new(1, 0, 1, 0),
            BackgroundTransparency = 1,
            Text = "🔐",
            TextSize = ScaleFont(24)
        })
        lockIcon.Parent = iconContainer
    end
    
    -- Title
    local titleLabel = CreateElement("TextLabel", {
        Name = "TitleLabel",
        Size = UDim2.new(1, -Scale(40), 0, Scale(24)),
        Position = UDim2.new(0, Scale(20), 0, Scale(96)),
        BackgroundTransparency = 1,
        Text = "Authentication Required",
        TextColor3 = CONFIG.TEXT_PRIMARY,
        TextSize = ScaleFont(18),
        Font = Enum.Font.GothamBold,
        TextXAlignment = Enum.TextXAlignment.Center
    })
    titleLabel.Parent = keyWindow
    
    local descLabel = CreateElement("TextLabel", {
        Name = "DescLabel",
        Size = UDim2.new(1, -Scale(40), 0, Scale(20)),
        Position = UDim2.new(0, Scale(20), 0, Scale(122)),
        BackgroundTransparency = 1,
        Text = "Enter your license key to continue",
        TextColor3 = CONFIG.TEXT_SECONDARY,
        TextSize = ScaleFont(13),
        Font = Enum.Font.GothamMedium,
        TextXAlignment = Enum.TextXAlignment.Center
    })
    descLabel.Parent = keyWindow
    
    -- Key input
    local keyInputFrame = CreateElement("Frame", {
        Name = "KeyInputFrame",
        Size = UDim2.new(1, -Scale(48), 0, Scale(46)),
        Position = UDim2.new(0, Scale(24), 0, Scale(158)),
        BackgroundColor3 = CONFIG.SURFACE_4,
        BorderSizePixel = 0
    })
    keyInputFrame.Parent = keyWindow
    
    AddCorner(keyInputFrame, CONFIG.RADIUS_MD)
    local keyInputStroke = AddStroke(keyInputFrame, 1, CONFIG.BORDER_DEFAULT, 0.3)
    
    local keyInput = CreateElement("TextBox", {
        Name = "KeyInput",
        Size = UDim2.new(1, -Scale(24), 1, 0),
        Position = UDim2.new(0, Scale(12), 0, 0),
        BackgroundTransparency = 1,
        Text = "",
        PlaceholderText = "Enter your license key...",
        PlaceholderColor3 = CONFIG.TEXT_MUTED,
        TextColor3 = CONFIG.TEXT_PRIMARY,
        TextSize = ScaleFont(14),
        Font = Enum.Font.GothamMedium,
        TextXAlignment = Enum.TextXAlignment.Left,
        ClearTextOnFocus = false
    })
    keyInput.Parent = keyInputFrame
    
    keyInput.Focused:Connect(function()
        CreateQuickTween(keyInputStroke, CONFIG.DURATION_FAST, {
            Color = CONFIG.ACCENT_PRIMARY,
            Transparency = 0
        }):Play()
    end)
    
    keyInput.FocusLost:Connect(function()
        CreateQuickTween(keyInputStroke, CONFIG.DURATION_FAST, {
            Color = CONFIG.BORDER_DEFAULT,
            Transparency = 0.3
        }):Play()
    end)
    
    -- Status label
    local statusLabel = CreateElement("TextLabel", {
        Name = "StatusLabel",
        Size = UDim2.new(1, -Scale(48), 0, Scale(18)),
        Position = UDim2.new(0, Scale(24), 0, Scale(210)),
        BackgroundTransparency = 1,
        Text = "",
        TextColor3 = CONFIG.ERROR,
        TextSize = ScaleFont(12),
        Font = Enum.Font.GothamMedium,
        TextXAlignment = Enum.TextXAlignment.Center
    })
    statusLabel.Parent = keyWindow
    
    -- Submit button
    local submitButton = CreateElement("TextButton", {
        Name = "VortexSubmitButton",
        Size = UDim2.new(1, -Scale(48), 0, Scale(44)),
        Position = UDim2.new(0, Scale(24), 0, Scale(236)),
        BackgroundColor3 = CONFIG.ACCENT_PRIMARY,
        BorderSizePixel = 0,
        Text = "Authenticate",
        TextColor3 = CONFIG.TEXT_PRIMARY,
        TextSize = ScaleFont(14),
        Font = Enum.Font.GothamBold,
        AutoButtonColor = false
    })
    submitButton.Parent = keyWindow
    
    AddCorner(submitButton, CONFIG.RADIUS_MD)
    AddGradient(submitButton, 180)
    
    submitButton.MouseEnter:Connect(function()
        CreateQuickTween(submitButton, CONFIG.DURATION_FAST, {
            BackgroundColor3 = CONFIG.ACCENT_HOVER
        }):Play()
    end)
    
    submitButton.MouseLeave:Connect(function()
        CreateQuickTween(submitButton, CONFIG.DURATION_FAST, {
            BackgroundColor3 = CONFIG.ACCENT_PRIMARY
        }):Play()
    end)
    
    -- Close button
    local closeButton = CreateElement("TextButton", {
        Name = "CloseButton",
        Size = UDim2.new(0, Scale(32), 0, Scale(32)),
        Position = UDim2.new(1, -Scale(44), 0, Scale(12)),
        BackgroundColor3 = CONFIG.SURFACE_3,
        BackgroundTransparency = 1,
        BorderSizePixel = 0,
        Text = "×",
        TextColor3 = CONFIG.TEXT_SECONDARY,
        TextSize = ScaleFont(20),
        Font = Enum.Font.GothamBold,
        AutoButtonColor = false
    })
    closeButton.Parent = keyWindow
    AddCorner(closeButton, CONFIG.RADIUS_FULL)
    
    closeButton.MouseEnter:Connect(function()
        CreateQuickTween(closeButton, CONFIG.DURATION_FAST, {
            BackgroundTransparency = 0,
            BackgroundColor3 = CONFIG.ERROR
        }):Play()
        CreateQuickTween(closeButton, CONFIG.DURATION_FAST, {
            TextColor3 = CONFIG.TEXT_PRIMARY
        }):Play()
    end)
    
    closeButton.MouseLeave:Connect(function()
        CreateQuickTween(closeButton, CONFIG.DURATION_FAST, {
            BackgroundTransparency = 1
        }):Play()
        CreateQuickTween(closeButton, CONFIG.DURATION_FAST, {
            TextColor3 = CONFIG.TEXT_SECONDARY
        }):Play()
    end)
    
    -- Shake animation helper
    local function shakeElement(element)
        local originalPos = element.Position
        for i = 1, 3 do
            CreateQuickTween(element, 0.05, {
                Position = UDim2.new(originalPos.X.Scale, originalPos.X.Offset + 6, originalPos.Y.Scale, originalPos.Y.Offset)
            }):Play()
            task.wait(0.05)
            CreateQuickTween(element, 0.05, {
                Position = UDim2.new(originalPos.X.Scale, originalPos.X.Offset - 6, originalPos.Y.Scale, originalPos.Y.Offset)
            }):Play()
            task.wait(0.05)
        end
        CreateQuickTween(element, 0.05, {
            Position = originalPos
        }):Play()
    end
    
    -- Submit functionality
    submitButton.MouseButton1Click:Connect(function()
        local enteredKey = keyInput.Text
        
        if enteredKey == "" then
            statusLabel.Text = "Please enter a key"
            statusLabel.TextColor3 = CONFIG.ERROR
            shakeElement(keyInputFrame)
            return
        end
        
        submitButton.Text = "Validating..."
        
        local isValidKey = false
        for _, validKey in ipairs(keySystemData.ValidKeys) do
            if enteredKey == validKey then
                isValidKey = true
                break
            end
        end
        
        if isValidKey then
            statusLabel.Text = "Authentication successful!"
            statusLabel.TextColor3 = CONFIG.SUCCESS
            
            CreateSmoothTween(submitButton, CONFIG.DURATION_NORMAL, {
                BackgroundColor3 = CONFIG.SUCCESS
            }):Play()
            submitButton.Text = "Success!"
            
            KeySystem.LastValidKey = enteredKey
            
            task.wait(1)
            
            CreateSpringTween(keyWindow, CONFIG.DURATION_NORMAL, {
                Size = UDim2.new(0, 0, 0, 0),
                Position = UDim2.new(0.5, 0, 0.5, 0),
                BackgroundTransparency = 1
            }):Play()
            
            CreateSmoothTween(overlay, CONFIG.DURATION_NORMAL, {
                BackgroundTransparency = 1
            }):Play()
            
            task.wait(CONFIG.DURATION_NORMAL)
            screenGui:Destroy()
            callback(true)
        else
            statusLabel.Text = "Invalid key. Please try again."
            statusLabel.TextColor3 = CONFIG.ERROR
            shakeElement(keyWindow)
            
            submitButton.Text = "Authenticate"
            CreateSmoothTween(submitButton, CONFIG.DURATION_NORMAL, {
                BackgroundColor3 = CONFIG.ACCENT_PRIMARY
            }):Play()
        end
    end)
    
    closeButton.MouseButton1Click:Connect(function()
        CreateSpringTween(keyWindow, CONFIG.DURATION_NORMAL, {
            Size = UDim2.new(0, 0, 0, 0),
            Position = UDim2.new(0.5, 0, 0.5, 0),
            BackgroundTransparency = 1
        }):Play()
        
        CreateSmoothTween(overlay, CONFIG.DURATION_NORMAL, {
            BackgroundTransparency = 1
        }):Play()
        
        task.wait(CONFIG.DURATION_NORMAL)
        screenGui:Destroy()
        callback(false)
    end)
    
    keyInput.FocusLost:Connect(function(enterPressed)
        if enterPressed then
            submitButton.MouseButton1Click:Fire()
        end
    end)
end

return VortexUI
