local VortexUI = {}
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local player = game.Players.LocalPlayer

-- Load Icons module
local Icons = loadstring(game:HttpGet("https://raw.githubusercontent.com/Footagesus/Icons/refs/heads/main/lucide/dist/Icons.lua"))()

-- Refined color palette with softer, more cohesive tones
local CONFIG = {
    -- Base colors - slightly warmer dark tones
    PRIMARY_COLOR = Color3.fromRGB(16, 16, 20),
    SECONDARY_COLOR = Color3.fromRGB(24, 24, 30),
    PANEL_COLOR = Color3.fromRGB(34, 34, 42),
    INPUT_COLOR = Color3.fromRGB(44, 44, 54),
    
    -- Text colors with better hierarchy
    TEXT_COLOR = Color3.fromRGB(250, 250, 252),
    SUB_TEXT_COLOR = Color3.fromRGB(156, 163, 175),
    MUTED_COLOR = Color3.fromRGB(107, 114, 128),
    
    -- Border and divider colors - subtle
    BORDER_COLOR = Color3.fromRGB(50, 50, 60),
    DIVIDER_COLOR = Color3.fromRGB(40, 40, 50),
    
    -- Accent colors - refined blue-violet
    ACCENT_COLOR = Color3.fromRGB(99, 102, 241),
    ACCENT_HOVER = Color3.fromRGB(124, 128, 252),
    ACCENT_GLOW = Color3.fromRGB(165, 180, 252),
    ACCENT_DIM = Color3.fromRGB(79, 82, 200),
    
    -- Status colors
    SUCCESS_COLOR = Color3.fromRGB(34, 197, 94),
    SUCCESS_GLOW = Color3.fromRGB(74, 222, 128),
    ERROR_COLOR = Color3.fromRGB(239, 68, 68),
    ERROR_GLOW = Color3.fromRGB(252, 129, 129),
    WARNING_COLOR = Color3.fromRGB(245, 158, 11),
    
    -- Design tokens
    CORNER_RADIUS = UDim.new(0, 8),
    CORNER_RADIUS_SM = UDim.new(0, 5),
    CORNER_RADIUS_LG = UDim.new(0, 12),
    CORNER_RADIUS_XL = UDim.new(0, 16),
    BORDER_THICKNESS = 1,
    TRANSITION_TIME = 0.2,
    TRANSITION_TIME_FAST = 0.12,
    
    -- Shadow
    SHADOW_COLOR = Color3.fromRGB(0, 0, 0),
    SHADOW_TRANSPARENCY = 0.5
}

-- Storage for elements and their states
local Elements = {}
local ToggleStates = {}
local WindowInstances = {}
local KeySystem = {
    Enabled = false,
    ValidKeys = {},
    Authenticated = false,
    LastValidKey = nil
}

-- Cleanup system
local CleanupManager = {
    ActiveConnections = {},
    ActiveLoops = {},
    ActiveToggles = {},
    CleanupCallbacks = {}
}

-- Utility Functions
local function CreateElement(elementType, properties)
    local element = Instance.new(elementType)
    for prop, value in pairs(properties) do
        element[prop] = value
    end
    
    if elementType == "TextButton" then
        element.AutoButtonColor = properties.AutoButtonColor ~= false
        element.TextColor3 = properties.TextColor3 or Color3.new(1, 1, 1)
        element.TextSize = properties.TextSize or 14
        element.Font = properties.Font or Enum.Font.GothamMedium
    end
    
    return element
end

local function AddCorner(parent, radius)
    local corner = Instance.new("UICorner")
    corner.CornerRadius = radius or CONFIG.CORNER_RADIUS
    corner.Parent = parent
    return corner
end

local function AddStroke(parent, thickness, color, transparency)
    local stroke = CreateElement("UIStroke", {
        Thickness = thickness or CONFIG.BORDER_THICKNESS,
        Color = color or CONFIG.BORDER_COLOR,
        Transparency = transparency or 0
    })
    stroke.Parent = parent
    return stroke
end

-- Improved drop shadow using 9-slice image
local function AddDropShadow(parent, size, transparency)
    size = size or 24
    transparency = transparency or 0.6
    
    local shadow = CreateElement("ImageLabel", {
        Name = "DropShadow",
        AnchorPoint = Vector2.new(0.5, 0.5),
        BackgroundTransparency = 1,
        Position = UDim2.new(0.5, 0, 0.5, 4),
        Size = UDim2.new(1, size, 1, size),
        ZIndex = -1,
        Image = "rbxassetid://6015897843",
        ImageColor3 = CONFIG.SHADOW_COLOR,
        ImageTransparency = transparency,
        ScaleType = Enum.ScaleType.Slice,
        SliceCenter = Rect.new(49, 49, 450, 450)
    })
    shadow.Parent = parent
    return shadow
end

local function AddGradient(parent, startColor, endColor, rotation)
    local gradient = Instance.new("UIGradient")
    gradient.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, startColor or parent.BackgroundColor3),
        ColorSequenceKeypoint.new(1, endColor or Color3.new(
            math.max(0, parent.BackgroundColor3.R - 0.02),
            math.max(0, parent.BackgroundColor3.G - 0.02),
            math.max(0, parent.BackgroundColor3.B - 0.02)
        ))
    }
    gradient.Rotation = rotation or 90
    gradient.Parent = parent
    return gradient
end

local function CreateTween(object, info, properties)
    return TweenService:Create(object, info, properties)
end

-- Cleanup Manager Functions
local function TrackConnection(connection, window)
    if not CleanupManager.ActiveConnections[window] then
        CleanupManager.ActiveConnections[window] = {}
    end
    table.insert(CleanupManager.ActiveConnections[window], connection)
    return connection
end

local function TrackLoop(loopFunction, window, loopName)
    if not CleanupManager.ActiveLoops[window] then
        CleanupManager.ActiveLoops[window] = {}
    end
    CleanupManager.ActiveLoops[window][loopName] = loopFunction
end

local function TrackToggle(toggleCallback, window, toggleName)
    if not CleanupManager.ActiveToggles[window] then
        CleanupManager.ActiveToggles[window] = {}
    end
    CleanupManager.ActiveToggles[window][toggleName] = toggleCallback
end

local function AddCleanupCallback(callback, window)
    if not CleanupManager.CleanupCallbacks[window] then
        CleanupManager.CleanupCallbacks[window] = {}
    end
    table.insert(CleanupManager.CleanupCallbacks[window], callback)
end

local function CleanupWindow(window)
    if CleanupManager.ActiveConnections[window] then
        for _, connection in ipairs(CleanupManager.ActiveConnections[window]) do
            if connection and connection.Disconnect then
                connection:Disconnect()
            end
        end
        CleanupManager.ActiveConnections[window] = {}
    end
    
    if CleanupManager.ActiveLoops[window] then
        for loopName, loopFunction in pairs(CleanupManager.ActiveLoops[window]) do
            if type(loopFunction) == "function" then
                pcall(loopFunction, false)
            end
        end
        CleanupManager.ActiveLoops[window] = {}
    end
    
    if CleanupManager.ActiveToggles[window] then
        for toggleName, toggleCallback in pairs(CleanupManager.ActiveToggles[window]) do
            if type(toggleCallback) == "function" then
                pcall(toggleCallback, false)
            end
        end
        CleanupManager.ActiveToggles[window] = {}
    end
    
    if CleanupManager.CleanupCallbacks[window] then
        for _, callback in ipairs(CleanupManager.CleanupCallbacks[window]) do
            if type(callback) == "function" then
                pcall(callback)
            end
        end
        CleanupManager.CleanupCallbacks[window] = {}
    end
    
    for flag in pairs(ToggleStates) do
        if type(ToggleStates[flag]) == "boolean" then
            ToggleStates[flag] = false
        end
    end
end

-- Main Window Creation
function VortexUI:CreateWindow(options)
    local windowName = options.Name or "Vortex UI"
    local keySystem = options.KeySystem or nil
    local onWindowCreated = options.OnWindowCreated or nil
    
    if keySystem then
        KeySystem.Enabled = true
        KeySystem.ValidKeys = keySystem.ValidKeys or {}
        KeySystem.Authenticated = false
        
        if not KeySystem.Authenticated then
            VortexUI:ShowKeyWindow(function(success)
                if success then
                    KeySystem.Authenticated = true
                    local windowOptions = {
                        Name = windowName,
                        KeySystem = nil,
                        OnWindowCreated = onWindowCreated
                    }
                    VortexUI:CreateWindow(windowOptions)
                end
            end, KeySystem)
            return nil
        end
    end
    
    local window = {}
    
    local CoreGui = game:GetService("CoreGui")
    for _, child in ipairs(CoreGui:GetChildren()) do
        if child.Name == "VortexUI" then
            child:Destroy()
        end
    end
    
    local screenGui = CreateElement("ScreenGui", {
        Name = "VortexUI",
        IgnoreGuiInset = true,
        ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    })
    screenGui.Parent = CoreGui
    
    -- Main Frame - using ClipsDescendants for external-only rounded corners
    local mainFrame = CreateElement("Frame", {
        Name = "MainFrame",
        Size = UDim2.new(0, 820, 0, 520),
        Position = UDim2.new(0.5, -410, 0.5, -260),
        BackgroundColor3 = CONFIG.PRIMARY_COLOR,
        BorderSizePixel = 0,
        ClipsDescendants = true -- This clips internal content to the rounded shape
    })
    mainFrame.Parent = screenGui
    
    -- Add rounded corners to main frame only
    local mainCorner = Instance.new("UICorner")
    mainCorner.CornerRadius = CONFIG.CORNER_RADIUS_XL
    mainCorner.Parent = mainFrame
    
    -- Subtle border
    AddStroke(mainFrame, 1, CONFIG.BORDER_COLOR, 0.4)
    
    -- Add drop shadow
    AddDropShadow(mainFrame, 32, 0.5)
    
    -- Header Bar - NO corner radius, parent clips it
    local headerBar = CreateElement("Frame", {
        Name = "HeaderBar",
        Size = UDim2.new(1, 0, 0, 52),
        Position = UDim2.new(0, 0, 0, 0),
        BackgroundColor3 = CONFIG.SECONDARY_COLOR,
        BorderSizePixel = 0
    })
    headerBar.Parent = mainFrame
    
    -- Subtle gradient on header
    AddGradient(headerBar, 
        Color3.fromRGB(28, 28, 35), 
        CONFIG.SECONDARY_COLOR, 
        180
    )
    
    -- Divider line under header
    local headerDivider = CreateElement("Frame", {
        Name = "HeaderDivider",
        Size = UDim2.new(1, 0, 0, 1),
        Position = UDim2.new(0, 0, 1, -1),
        BackgroundColor3 = CONFIG.DIVIDER_COLOR,
        BorderSizePixel = 0
    })
    headerDivider.Parent = headerBar
    
    -- Logo Frame
    local logoFrame = CreateElement("Frame", {
        Name = "LogoFrame",
        Size = UDim2.new(0, 34, 0, 34),
        Position = UDim2.new(0, 14, 0.5, -17),
        BackgroundColor3 = CONFIG.ACCENT_COLOR,
        BorderSizePixel = 0,
        Active = false
    })
    logoFrame.Parent = headerBar
    AddCorner(logoFrame, CONFIG.CORNER_RADIUS)
    
    local logoImage = CreateElement("ImageLabel", {
        Name = "LogoImage",
        Size = UDim2.new(1, -6, 1, -6),
        Position = UDim2.new(0.5, 0, 0.5, 0),
        AnchorPoint = Vector2.new(0.5, 0.5),
        BackgroundTransparency = 1,
        Image = "rbxassetid://97748628737538",
        ImageTransparency = 0
    })
    logoImage.Parent = logoFrame
    
    -- Title
    local titleLabel = CreateElement("TextLabel", {
        Name = "TitleLabel",
        Size = UDim2.new(1, -160, 0, 20),
        Position = UDim2.new(0, 58, 0.5, -10),
        BackgroundTransparency = 1,
        Text = windowName,
        TextColor3 = CONFIG.TEXT_COLOR,
        TextSize = 16,
        Font = Enum.Font.GothamBold,
        TextXAlignment = Enum.TextXAlignment.Left
    })
    titleLabel.Parent = headerBar
    
    -- Improved window controls with cleaner design
    local controlsContainer = CreateElement("Frame", {
        Name = "ControlsContainer",
        Size = UDim2.new(0, 72, 0, 28),
        Position = UDim2.new(1, -86, 0.5, -14),
        BackgroundColor3 = CONFIG.PANEL_COLOR,
        BorderSizePixel = 0
    })
    controlsContainer.Parent = headerBar
    AddCorner(controlsContainer, UDim.new(0, 14))
    AddStroke(controlsContainer, 1, CONFIG.BORDER_COLOR, 0.6)
    
    -- Minimize Button
    local minimizeButton = CreateElement("TextButton", {
        Name = "MinimizeButton",
        Size = UDim2.new(0, 28, 0, 22),
        Position = UDim2.new(0, 3, 0.5, -11),
        BackgroundColor3 = CONFIG.INPUT_COLOR,
        BackgroundTransparency = 1,
        BorderSizePixel = 0,
        Text = "",
        AutoButtonColor = false
    })
    minimizeButton.Parent = controlsContainer
    AddCorner(minimizeButton, UDim.new(0, 6))
    
    local minimizeIcon = CreateElement("TextLabel", {
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        Text = "−",
        TextColor3 = CONFIG.MUTED_COLOR,
        TextSize = 18,
        Font = Enum.Font.GothamBold
    })
    minimizeIcon.Parent = minimizeButton
    
    -- Close Button
    local closeButton = CreateElement("TextButton", {
        Name = "CloseButton",
        Size = UDim2.new(0, 28, 0, 22),
        Position = UDim2.new(1, -31, 0.5, -11),
        BackgroundColor3 = CONFIG.INPUT_COLOR,
        BackgroundTransparency = 1,
        BorderSizePixel = 0,
        Text = "",
        AutoButtonColor = false
    })
    closeButton.Parent = controlsContainer
    AddCorner(closeButton, UDim.new(0, 6))
    
    local closeIcon = CreateElement("TextLabel", {
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        Text = "×",
        TextColor3 = CONFIG.MUTED_COLOR,
        TextSize = 18,
        Font = Enum.Font.GothamBold
    })
    closeIcon.Parent = closeButton
    
    -- Hover effects
    minimizeButton.MouseEnter:Connect(function()
        CreateTween(minimizeButton, TweenInfo.new(CONFIG.TRANSITION_TIME_FAST, Enum.EasingStyle.Quart), {
            BackgroundTransparency = 0
        }):Play()
        CreateTween(minimizeIcon, TweenInfo.new(CONFIG.TRANSITION_TIME_FAST), {
            TextColor3 = CONFIG.TEXT_COLOR
        }):Play()
    end)
    
    minimizeButton.MouseLeave:Connect(function()
        CreateTween(minimizeButton, TweenInfo.new(CONFIG.TRANSITION_TIME_FAST, Enum.EasingStyle.Quart), {
            BackgroundTransparency = 1
        }):Play()
        CreateTween(minimizeIcon, TweenInfo.new(CONFIG.TRANSITION_TIME_FAST), {
            TextColor3 = CONFIG.MUTED_COLOR
        }):Play()
    end)
    
    closeButton.MouseEnter:Connect(function()
        CreateTween(closeButton, TweenInfo.new(CONFIG.TRANSITION_TIME_FAST, Enum.EasingStyle.Quart), {
            BackgroundTransparency = 0,
            BackgroundColor3 = CONFIG.ERROR_COLOR
        }):Play()
        CreateTween(closeIcon, TweenInfo.new(CONFIG.TRANSITION_TIME_FAST), {
            TextColor3 = CONFIG.TEXT_COLOR
        }):Play()
    end)
    
    closeButton.MouseLeave:Connect(function()
        CreateTween(closeButton, TweenInfo.new(CONFIG.TRANSITION_TIME_FAST, Enum.EasingStyle.Quart), {
            BackgroundTransparency = 1,
            BackgroundColor3 = CONFIG.INPUT_COLOR
        }):Play()
        CreateTween(closeIcon, TweenInfo.new(CONFIG.TRANSITION_TIME_FAST), {
            TextColor3 = CONFIG.MUTED_COLOR
        }):Play()
    end)
    
    -- Minimize/Maximize functionality
    local isMinimized = false
    local originalSize = mainFrame.Size
    local originalPosition = mainFrame.Position
    local minimizedSize = UDim2.new(0, 200, 0, 52)
    local originalVisibilities = {}
    local currentTween = nil
    
    local function keepInBounds(position, size)
        local viewportSize = workspace.CurrentCamera.ViewportSize
        local x = position.X.Offset + position.X.Scale * viewportSize.X
        local y = position.Y.Offset + position.Y.Scale * viewportSize.Y
        local width = size.X.Offset + size.X.Scale * viewportSize.X
        local height = size.Y.Offset + size.Y.Scale * viewportSize.Y
        
        x = math.max(0, math.min(x, viewportSize.X - width))
        y = math.max(0, math.min(y, viewportSize.Y - height))
        
        return UDim2.new(0, x, 0, y)
    end
    
    -- Content Frame - NO corner radius
    local contentFrame = CreateElement("Frame", {
        Name = "ContentFrame",
        Size = UDim2.new(1, 0, 1, -52),
        Position = UDim2.new(0, 0, 0, 52),
        BackgroundColor3 = CONFIG.PRIMARY_COLOR,
        BorderSizePixel = 0
    })
    contentFrame.Parent = mainFrame
    
    -- Sidebar - NO corner radius, parent clips the corners
    local sidebarFrame = CreateElement("Frame", {
        Name = "SidebarFrame",
        Size = UDim2.new(0, 180, 1, 0),
        Position = UDim2.new(0, 0, 0, 0),
        BackgroundColor3 = CONFIG.SECONDARY_COLOR,
        BorderSizePixel = 0
    })
    sidebarFrame.Parent = contentFrame
    
    -- Sidebar right border
    local sidebarBorder = CreateElement("Frame", {
        Name = "SidebarBorder",
        Size = UDim2.new(0, 1, 1, 0),
        Position = UDim2.new(1, 0, 0, 0),
        BackgroundColor3 = CONFIG.DIVIDER_COLOR,
        BorderSizePixel = 0
    })
    sidebarBorder.Parent = sidebarFrame
    
    -- Sidebar padding
    local sidebarPadding = CreateElement("UIPadding", {
        PaddingTop = UDim.new(0, 10),
        PaddingLeft = UDim.new(0, 10),
        PaddingRight = UDim.new(0, 10),
        PaddingBottom = UDim.new(0, 10)
    })
    sidebarPadding.Parent = sidebarFrame
    
    -- Content Area
    local contentArea = CreateElement("ScrollingFrame", {
        Name = "ContentArea",
        Size = UDim2.new(1, -180, 1, 0),
        Position = UDim2.new(0, 180, 0, 0),
        BackgroundColor3 = CONFIG.PRIMARY_COLOR,
        BorderSizePixel = 0,
        ScrollBarThickness = 3,
        ScrollBarImageColor3 = CONFIG.ACCENT_COLOR,
        ScrollBarImageTransparency = 0.4,
        TopImage = "rbxassetid://6015897843",
        MidImage = "rbxassetid://6015897843",
        BottomImage = "rbxassetid://6015897843"
    })
    contentArea.Parent = contentFrame
    contentArea.ClipsDescendants = true
    
    local function updateMinimizedState()
        local tweenInfo = TweenInfo.new(0.3, Enum.EasingStyle.Quart, Enum.EasingDirection.Out)
        
        if isMinimized then
            originalPosition = mainFrame.Position
            originalVisibilities = {}
            
            for _, child in ipairs(mainFrame:GetChildren()) do
                if child:IsA("GuiObject") and not child:IsA("UIListLayout") and not child:IsA("UIPadding") then
                    originalVisibilities[child] = child.Visible
                end
            end
            
            local minimizedPos = keepInBounds(mainFrame.Position, minimizedSize)
            
            if currentTween then currentTween:Cancel() end
            currentTween = TweenService:Create(mainFrame, tweenInfo, {
                Size = minimizedSize,
                Position = minimizedPos
            })
            currentTween:Play()
            
            for _, child in ipairs(mainFrame:GetChildren()) do
                if child ~= headerBar and child:IsA("GuiObject") and not child:IsA("UIListLayout") and not child:IsA("UIPadding") then
                    child.Visible = false
                end
            end
            
            headerBar.Visible = true
            
            for _, child in ipairs(headerBar:GetChildren()) do
                if child:IsA("GuiObject") and not child:IsA("UIListLayout") and not child:IsA("UIPadding") then
                    if child ~= logoFrame and child ~= controlsContainer and child ~= titleLabel and child.Name ~= "HeaderDivider" then
                        child.Visible = false
                    else
                        child.Visible = true
                    end
                end
            end
            
            if contentArea then contentArea.Visible = false end
            if sidebarFrame then sidebarFrame.Visible = false end
            
            headerBar.Size = UDim2.new(1, 0, 1, 0)
            titleLabel.Visible = false
        else
            local restoredPos = keepInBounds(originalPosition, originalSize)
            
            if currentTween then currentTween:Cancel() end
            currentTween = TweenService:Create(mainFrame, tweenInfo, {
                Size = originalSize,
                Position = restoredPos
            })
            currentTween:Play()
            
            for child, wasVisible in pairs(originalVisibilities) do
                if child.Parent then
                    child.Visible = wasVisible
                end
            end
            
            if contentArea then contentArea.Visible = true end
            if sidebarFrame then sidebarFrame.Visible = true end
            if titleLabel then titleLabel.Visible = true end
            
            headerBar.Size = UDim2.new(1, 0, 0, 52)
            originalPosition = restoredPos
        end
    end
    
    minimizeButton.MouseButton1Click:Connect(function()
        isMinimized = not isMinimized
        updateMinimizedState()
    end)
    
    -- Dragging
    local dragging
    local dragInput
    local dragStart
    local startPos
    
    local function update(input)
        local delta = input.Position - dragStart
        local newPosition = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        local boundedPosition = keepInBounds(newPosition, isMinimized and minimizedSize or mainFrame.Size)
        mainFrame.Position = boundedPosition
    end
    
    local function handleDragStart(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = mainFrame.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                    if not isMinimized then
                        originalPosition = mainFrame.Position
                    end
                end
            end)
        end
    end
    
    local function handleInputChanged(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end
    
    local function setupDrag(element)
        element.InputBegan:Connect(handleDragStart)
        element.InputChanged:Connect(handleInputChanged)
    end
    
    setupDrag(headerBar)
    setupDrag(logoFrame)
    
    local dragConnection = UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            update(input)
        end
    end)
    
    TrackConnection(dragConnection, window)
    
    closeButton.MouseButton1Click:Connect(function()
        CleanupWindow(window)
        screenGui:Destroy()
    end)
    
    local windowNameVar = "VortexUI"
    local cleanupCalled = false
    
    local destructionConnection
    destructionConnection = game:GetService("RunService").Heartbeat:Connect(function()
        if not screenGui or not screenGui.Parent then
            if not cleanupCalled then
                cleanupCalled = true
                if destructionConnection then
                    destructionConnection:Disconnect()
                end
                CleanupWindow(window)
            end
        end
    end)
    
    local coreGuiConnection
    coreGuiConnection = CoreGui.ChildRemoved:Connect(function(child)
        if child.Name == windowNameVar then
            if not cleanupCalled then
                cleanupCalled = true
                if destructionConnection then
                    destructionConnection:Disconnect()
                end
                if coreGuiConnection then
                    coreGuiConnection:Disconnect()
                end
                CleanupWindow(window)
            end
        end
    end)
    
    TrackConnection(destructionConnection, window)
    TrackConnection(coreGuiConnection, window)
    
    WindowInstances[window] = {
        ScreenGui = screenGui,
        MainFrame = mainFrame,
        ContentFrame = contentFrame,
        SidebarFrame = sidebarFrame,
        ContentArea = contentArea,
        Tabs = {}
    }
    
    -- Window methods
    function window:CreateTab(options)
        local tabName = options.Name or "New Tab"
        local iconName = options.Icon
        local tab = {}
        
        local tabCount = 0
        for _ in pairs(WindowInstances[window].Tabs) do
            tabCount = tabCount + 1
        end
        
        -- Refined Tab Button styling
        local tabButton = CreateElement("TextButton", {
            Name = "TabButton_" .. tabName,
            Size = UDim2.new(1, 0, 0, 40),
            Position = UDim2.new(0, 0, 0, tabCount * 48),
            BackgroundColor3 = CONFIG.SECONDARY_COLOR,
            BackgroundTransparency = 1,
            BorderSizePixel = 0,
            Text = "",
            AutoButtonColor = false,
            ZIndex = 10
        })
        tabButton.Parent = sidebarFrame
        
        AddCorner(tabButton, CONFIG.CORNER_RADIUS)
        
        -- Tab Icon container
        local tabIconContainer = CreateElement("Frame", {
            Name = "IconContainer",
            Size = UDim2.new(0, 28, 0, 28),
            Position = UDim2.new(0, 6, 0.5, -14),
            BackgroundColor3 = CONFIG.PANEL_COLOR,
            BackgroundTransparency = 1,
            BorderSizePixel = 0
        })
        tabIconContainer.Parent = tabButton
        AddCorner(tabIconContainer, CONFIG.CORNER_RADIUS_SM)
        
        local tabLabel = CreateElement("TextLabel", {
            Name = "TabLabel",
            Size = UDim2.new(1, -48, 1, 0),
            Position = UDim2.new(0, 42, 0, 0),
            BackgroundTransparency = 1,
            Text = tabName,
            TextColor3 = CONFIG.SUB_TEXT_COLOR,
            TextSize = 13,
            Font = Enum.Font.GothamMedium,
            TextXAlignment = Enum.TextXAlignment.Left
        })
        tabLabel.Parent = tabButton
        
        local tabIcon = nil
        if iconName and Icons[iconName] then
            tabIcon = CreateElement("ImageLabel", {
                Name = "TabIcon",
                Size = UDim2.new(0, 16, 0, 16),
                Position = UDim2.new(0.5, 0, 0.5, 0),
                AnchorPoint = Vector2.new(0.5, 0.5),
                BackgroundTransparency = 1,
                Image = Icons[iconName],
                ImageColor3 = CONFIG.SUB_TEXT_COLOR
            })
            tabIcon.Parent = tabIconContainer
        end
        
        -- Accent indicator (left bar)
        local accentIndicator = CreateElement("Frame", {
            Name = "AccentIndicator",
            Size = UDim2.new(0, 3, 0, 18),
            Position = UDim2.new(0, 0, 0.5, -9),
            BackgroundColor3 = CONFIG.ACCENT_COLOR,
            BorderSizePixel = 0,
            Visible = false
        })
        accentIndicator.Parent = tabButton
        AddCorner(accentIndicator, UDim.new(0, 2))
        
        -- Tab hover effects
        tabButton.MouseEnter:Connect(function()
            if not accentIndicator.Visible then
                CreateTween(tabButton, TweenInfo.new(CONFIG.TRANSITION_TIME_FAST, Enum.EasingStyle.Quart), {
                    BackgroundTransparency = 0.6
                }):Play()
                CreateTween(tabLabel, TweenInfo.new(CONFIG.TRANSITION_TIME_FAST), {
                    TextColor3 = CONFIG.TEXT_COLOR
                }):Play()
                if tabIcon then
                    CreateTween(tabIcon, TweenInfo.new(CONFIG.TRANSITION_TIME_FAST), {
                        ImageColor3 = CONFIG.TEXT_COLOR
                    }):Play()
                end
            end
        end)
        
        tabButton.MouseLeave:Connect(function()
            if not accentIndicator.Visible then
                CreateTween(tabButton, TweenInfo.new(CONFIG.TRANSITION_TIME_FAST, Enum.EasingStyle.Quart), {
                    BackgroundTransparency = 1
                }):Play()
                CreateTween(tabLabel, TweenInfo.new(CONFIG.TRANSITION_TIME_FAST), {
                    TextColor3 = CONFIG.SUB_TEXT_COLOR
                }):Play()
                if tabIcon then
                    CreateTween(tabIcon, TweenInfo.new(CONFIG.TRANSITION_TIME_FAST), {
                        ImageColor3 = CONFIG.SUB_TEXT_COLOR
                    }):Play()
                end
            end
        end)
        
        local tabContent = CreateElement("Frame", {
            Name = "TabContent_" .. tabName,
            Size = UDim2.new(1, -40, 1, -40),
            Position = UDim2.new(0, 20, 0, 20),
            BackgroundColor3 = CONFIG.PRIMARY_COLOR,
            BackgroundTransparency = 1,
            BorderSizePixel = 0
        })
        tabContent.Parent = contentArea
        tabContent.ClipsDescendants = true
        
        local function updateCanvasSize()
            local layout = tabContent:FindFirstChildOfClass("UIListLayout")
            if layout then
                local absoluteContentSize = layout.AbsoluteContentSize
                contentArea.CanvasSize = UDim2.new(0, 0, 0, absoluteContentSize.Y + 40)
            end
        end
        
        -- Tab click handler
        tabButton.MouseButton1Click:Connect(function()
            if not WindowInstances[window].LastUsedTab then
                WindowInstances[window].LastUsedTab = {}
            end
            WindowInstances[window].LastUsedTab[windowName or "default"] = tabContent
            
            for _, otherTab in pairs(WindowInstances[window].Tabs) do
                if otherTab.Content ~= tabContent then
                    CreateTween(otherTab.Content, TweenInfo.new(CONFIG.TRANSITION_TIME_FAST, Enum.EasingStyle.Quart), {
                        BackgroundTransparency = 1
                    }):Play()
                    
                    CreateTween(otherTab.Button, TweenInfo.new(CONFIG.TRANSITION_TIME_FAST, Enum.EasingStyle.Quart), {
                        BackgroundTransparency = 1
                    }):Play()
                    
                    local otherLabel = otherTab.Button:FindFirstChild("TabLabel")
                    if otherLabel then
                        CreateTween(otherLabel, TweenInfo.new(CONFIG.TRANSITION_TIME_FAST), {
                            TextColor3 = CONFIG.SUB_TEXT_COLOR
                        }):Play()
                    end
                    
                    local otherIconContainer = otherTab.Button:FindFirstChild("IconContainer")
                    if otherIconContainer then
                        local otherIcon = otherIconContainer:FindFirstChild("TabIcon")
                        if otherIcon then
                            CreateTween(otherIcon, TweenInfo.new(CONFIG.TRANSITION_TIME_FAST), {
                                ImageColor3 = CONFIG.SUB_TEXT_COLOR
                            }):Play()
                        end
                    end
                    
                    CreateTween(otherTab.AccentIndicator, TweenInfo.new(CONFIG.TRANSITION_TIME_FAST, Enum.EasingStyle.Quart), {
                        Size = UDim2.new(0, 3, 0, 0),
                        BackgroundTransparency = 1
                    }):Play()
                    
                    otherTab.Content.Visible = false
                    otherTab.AccentIndicator.Visible = false
                    otherTab.AccentIndicator.Size = UDim2.new(0, 3, 0, 18)
                    otherTab.AccentIndicator.BackgroundTransparency = 0
                end
            end
            
            tabContent.Visible = true
            tabContent.BackgroundTransparency = 1
            
            CreateTween(tabContent, TweenInfo.new(CONFIG.TRANSITION_TIME, Enum.EasingStyle.Quart), {
                BackgroundTransparency = 0
            }):Play()
            
            CreateTween(tabButton, TweenInfo.new(CONFIG.TRANSITION_TIME_FAST, Enum.EasingStyle.Quart), {
                BackgroundTransparency = 0.7
            }):Play()
            
            CreateTween(tabLabel, TweenInfo.new(CONFIG.TRANSITION_TIME_FAST), {
                TextColor3 = CONFIG.TEXT_COLOR
            }):Play()
            
            if tabIcon then
                CreateTween(tabIcon, TweenInfo.new(CONFIG.TRANSITION_TIME_FAST), {
                    ImageColor3 = CONFIG.ACCENT_COLOR
                }):Play()
            end
            
            accentIndicator.Visible = true
            accentIndicator.Size = UDim2.new(0, 3, 0, 0)
            accentIndicator.BackgroundTransparency = 1
            CreateTween(accentIndicator, TweenInfo.new(0.25, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
                Size = UDim2.new(0, 3, 0, 18),
                BackgroundTransparency = 0
            }):Play()
            
            updateCanvasSize()
        end)
        
        local tabLayout = CreateElement("UIListLayout", {
            SortOrder = Enum.SortOrder.LayoutOrder,
            Padding = UDim.new(0, 10)
        })
        tabLayout.Parent = tabContent
        
        tabLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(updateCanvasSize)
        
        WindowInstances[window].Tabs[tabName] = {
            Button = tabButton,
            Content = tabContent,
            AccentIndicator = accentIndicator,
            Icon = tabIcon,
            Elements = {}
        }
        
        -- Improved Button with cleaner styling
        function tab:CreateButton(options)
            local buttonName = options.Name or "Button"
            local callback = options.Callback or function() end
            
            local button = CreateElement("TextButton", {
                Name = buttonName,
                Size = UDim2.new(0, 160, 0, 38),
                BackgroundColor3 = CONFIG.ACCENT_COLOR,
                BorderSizePixel = 0,
                Text = buttonName,
                TextColor3 = Color3.new(1, 1, 1),
                TextSize = 13,
                Font = Enum.Font.GothamSemibold,
                AutoButtonColor = false
            })
            button.Parent = tabContent
            
            AddCorner(button, CONFIG.CORNER_RADIUS)
            
            button.MouseEnter:Connect(function()
                CreateTween(button, TweenInfo.new(CONFIG.TRANSITION_TIME_FAST, Enum.EasingStyle.Quart), {
                    BackgroundColor3 = CONFIG.ACCENT_HOVER
                }):Play()
            end)
            
            button.MouseLeave:Connect(function()
                CreateTween(button, TweenInfo.new(CONFIG.TRANSITION_TIME_FAST, Enum.EasingStyle.Quart), {
                    BackgroundColor3 = CONFIG.ACCENT_COLOR
                }):Play()
            end)
            
            button.MouseButton1Click:Connect(function()
                CreateTween(button, TweenInfo.new(0.08), {
                    Size = UDim2.new(0, 156, 0, 36)
                }):Play()
                task.wait(0.08)
                CreateTween(button, TweenInfo.new(0.12, Enum.EasingStyle.Back), {
                    Size = UDim2.new(0, 160, 0, 38)
                }):Play()
                callback()
            end)
            
            WindowInstances[window].Tabs[tabName].Elements[buttonName] = button
            
            task.wait()
            updateCanvasSize()
            
            local element = {}
            function element:Set(newName)
                button.Text = newName
            end
            return element
        end
        
        -- Section divider
        function tab:CreateSection(title)
            local sectionFrame = CreateElement("Frame", {
                Name = "Section_" .. (title or ""),
                Size = UDim2.new(1, 0, 0, 32),
                BackgroundTransparency = 1,
                BorderSizePixel = 0
            })
            sectionFrame.Parent = tabContent
            
            local leftLine = CreateElement("Frame", {
                Name = "LeftLine",
                Size = UDim2.new(0.3, -8, 0, 1),
                Position = UDim2.new(0, 0, 0.5, 0),
                BackgroundColor3 = CONFIG.DIVIDER_COLOR,
                BorderSizePixel = 0
            })
            leftLine.Parent = sectionFrame
            
            local sectionLabel = CreateElement("TextLabel", {
                Name = "SectionLabel",
                Size = UDim2.new(0.4, 0, 1, 0),
                Position = UDim2.new(0.3, 0, 0, 0),
                BackgroundTransparency = 1,
                Text = title or "Section",
                TextColor3 = CONFIG.MUTED_COLOR,
                TextSize = 11,
                Font = Enum.Font.GothamMedium,
                TextTransparency = 0.2
            })
            sectionLabel.Parent = sectionFrame
            
            local rightLine = CreateElement("Frame", {
                Name = "RightLine",
                Size = UDim2.new(0.3, -8, 0, 1),
                Position = UDim2.new(0.7, 8, 0.5, 0),
                BackgroundColor3 = CONFIG.DIVIDER_COLOR,
                BorderSizePixel = 0
            })
            rightLine.Parent = sectionFrame
            
            task.wait()
            updateCanvasSize()
        end
        
        -- Paragraph
        function tab:CreateParagraph(options)
            local title = options.Title or "Title"
            local content = options.Content or "Content"
            
            local paragraphFrame = CreateElement("Frame", {
                Name = "Paragraph",
                Size = UDim2.new(1, 0, 0, 80),
                BackgroundColor3 = CONFIG.PANEL_COLOR,
                BorderSizePixel = 0
            })
            paragraphFrame.Parent = tabContent
            
            AddCorner(paragraphFrame, CONFIG.CORNER_RADIUS)
            
            local paragraphPadding = CreateElement("UIPadding", {
                PaddingTop = UDim.new(0, 14),
                PaddingLeft = UDim.new(0, 14),
                PaddingRight = UDim.new(0, 14),
                PaddingBottom = UDim.new(0, 14)
            })
            paragraphPadding.Parent = paragraphFrame
            
            local titleLabel = CreateElement("TextLabel", {
                Name = "Title",
                Size = UDim2.new(1, 0, 0, 18),
                Position = UDim2.new(0, 0, 0, 0),
                BackgroundTransparency = 1,
                Text = title,
                TextColor3 = CONFIG.TEXT_COLOR,
                TextSize = 14,
                Font = Enum.Font.GothamBold,
                TextXAlignment = Enum.TextXAlignment.Left
            })
            titleLabel.Parent = paragraphFrame
            
            local contentLabel = CreateElement("TextLabel", {
                Name = "Content",
                Size = UDim2.new(1, 0, 0, 0),
                Position = UDim2.new(0, 0, 0, 24),
                BackgroundTransparency = 1,
                Text = content,
                TextColor3 = CONFIG.SUB_TEXT_COLOR,
                TextSize = 12,
                Font = Enum.Font.Gotham,
                TextWrapped = true,
                TextXAlignment = Enum.TextXAlignment.Left,
                TextYAlignment = Enum.TextYAlignment.Top
            })
            contentLabel.Parent = paragraphFrame
            
            local function updateSize()
                local contentSize = contentLabel.TextBounds
                contentLabel.Size = UDim2.new(1, 0, 0, contentSize.Y)
                paragraphFrame.Size = UDim2.new(1, 0, 0, contentSize.Y + 52)
            end
            
            contentLabel:GetPropertyChangedSignal("Text"):Connect(updateSize)
            contentLabel:GetPropertyChangedSignal("TextSize"):Connect(updateSize)
            updateSize()
            
            local element = {}
            function element:Set(data)
                if data.Title ~= nil then titleLabel.Text = data.Title end
                if data.Content ~= nil then contentLabel.Text = data.Content end
                if data.TitleColor ~= nil then titleLabel.TextColor3 = data.TitleColor end
                if data.ContentColor ~= nil then contentLabel.TextColor3 = data.ContentColor end
            end
            
            task.wait()
            updateCanvasSize()
            
            return element
        end
        
        -- Improved Toggle with modern pill design
        function tab:CreateToggle(options)
            local toggleName = options.Name or "Toggle"
            local currentValue = options.CurrentValue or false
            local flag = options.Flag or toggleName
            local callback = options.Callback or function() end
            local isLocked = options.IsLocked or false
            
            local toggleFrame = CreateElement("Frame", {
                Name = "ToggleFrame_" .. toggleName,
                Size = UDim2.new(1, 0, 0, 44),
                BackgroundColor3 = CONFIG.PANEL_COLOR,
                BorderSizePixel = 0
            })
            toggleFrame.Parent = tabContent
            
            AddCorner(toggleFrame, CONFIG.CORNER_RADIUS)
            
            local label = CreateElement("TextLabel", {
                Name = "Label",
                Size = UDim2.new(1, -70, 1, 0),
                Position = UDim2.new(0, 14, 0, 0),
                BackgroundTransparency = 1,
                Text = toggleName,
                TextColor3 = CONFIG.TEXT_COLOR,
                TextSize = 13,
                Font = Enum.Font.GothamMedium,
                TextXAlignment = Enum.TextXAlignment.Left
            })
            label.Parent = toggleFrame
            
            -- Modern pill toggle
            local toggleButton = CreateElement("TextButton", {
                Name = "ToggleButton",
                Size = UDim2.new(0, 44, 0, 24),
                Position = UDim2.new(1, -58, 0.5, -12),
                BackgroundColor3 = CONFIG.INPUT_COLOR,
                BorderSizePixel = 0,
                Text = "",
                AutoButtonColor = false
            })
            toggleButton.Parent = toggleFrame
            
            AddCorner(toggleButton, UDim.new(0, 12))
            
            local toggleIndicator = CreateElement("Frame", {
                Name = "Indicator",
                Size = UDim2.new(0, 18, 0, 18),
                Position = UDim2.new(0, 3, 0.5, -9),
                BackgroundColor3 = CONFIG.TEXT_COLOR,
                BorderSizePixel = 0
            })
            toggleIndicator.Parent = toggleButton
            
            AddCorner(toggleIndicator, UDim.new(1, 0))
            
            ToggleStates[flag] = currentValue
            TrackToggle(callback, window, toggleName)
            
            local function updateToggle(enabled)
                if enabled then
                    CreateTween(toggleButton, TweenInfo.new(0.2, Enum.EasingStyle.Quart), {
                        BackgroundColor3 = isLocked and CONFIG.MUTED_COLOR or CONFIG.ACCENT_COLOR
                    }):Play()
                    CreateTween(toggleIndicator, TweenInfo.new(0.2, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
                        Position = UDim2.new(0, 23, 0.5, -9),
                        BackgroundColor3 = Color3.new(1, 1, 1)
                    }):Play()
                else
                    CreateTween(toggleButton, TweenInfo.new(0.2, Enum.EasingStyle.Quart), {
                        BackgroundColor3 = isLocked and Color3.fromRGB(50, 50, 55) or CONFIG.INPUT_COLOR
                    }):Play()
                    CreateTween(toggleIndicator, TweenInfo.new(0.2, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
                        Position = UDim2.new(0, 3, 0.5, -9),
                        BackgroundColor3 = isLocked and CONFIG.MUTED_COLOR or CONFIG.TEXT_COLOR
                    }):Play()
                end
            end
            
            updateToggle(currentValue)
            
            toggleButton.MouseButton1Click:Connect(function()
                if not isLocked then
                    currentValue = not currentValue
                    ToggleStates[flag] = currentValue
                    updateToggle(currentValue)
                    callback(currentValue)
                end
            end)
            
            WindowInstances[window].Tabs[tabName].Elements[toggleName] = toggleFrame
            
            local element = {}
            function element:Set(value, noCallback)
                if value ~= currentValue then
                    currentValue = value
                    ToggleStates[flag] = value
                    updateToggle(value)
                    if not noCallback then
                        callback(value)
                    end
                end
            end
            
            function element:Lock()
                isLocked = true
                updateToggle(currentValue)
            end
            
            function element:Unlock()
                isLocked = false
                updateToggle(currentValue)
            end
            
            function element:IsLocked()
                return isLocked
            end
            
            task.wait()
            updateCanvasSize()
            
            return element
        end
        
        -- Improved Slider with refined track design
        function tab:CreateSlider(options)
            local sliderName = options.Name or "Slider"
            local range = options.Range or {0, 100}
            local increment = options.Increment or 1
            local suffix = options.Suffix or ""
            local currentValue = options.CurrentValue or range[1]
            local flag = options.Flag or sliderName
            local callback = options.Callback or function() end
            
            local sliderFrame = CreateElement("Frame", {
                Name = "SliderFrame_" .. sliderName,
                Size = UDim2.new(1, 0, 0, 58),
                BackgroundColor3 = CONFIG.PANEL_COLOR,
                BorderSizePixel = 0
            })
            sliderFrame.Parent = tabContent
            
            AddCorner(sliderFrame, CONFIG.CORNER_RADIUS)
            
            local label = CreateElement("TextLabel", {
                Name = "Label",
                Size = UDim2.new(0.7, -14, 0, 18),
                Position = UDim2.new(0, 14, 0, 10),
                BackgroundTransparency = 1,
                Text = sliderName,
                TextColor3 = CONFIG.TEXT_COLOR,
                TextSize = 13,
                Font = Enum.Font.GothamMedium,
                TextXAlignment = Enum.TextXAlignment.Left
            })
            label.Parent = sliderFrame
            
            -- Value display
            local valueDisplay = CreateElement("Frame", {
                Name = "ValueDisplay",
                Size = UDim2.new(0, 52, 0, 20),
                Position = UDim2.new(1, -66, 0, 9),
                BackgroundColor3 = CONFIG.ACCENT_COLOR,
                BackgroundTransparency = 0.85,
                BorderSizePixel = 0
            })
            valueDisplay.Parent = sliderFrame
            AddCorner(valueDisplay, CONFIG.CORNER_RADIUS_SM)
            
            local valueLabel = CreateElement("TextLabel", {
                Name = "ValueLabel",
                Size = UDim2.new(1, 0, 1, 0),
                BackgroundTransparency = 1,
                Text = currentValue .. suffix,
                TextColor3 = CONFIG.ACCENT_COLOR,
                TextSize = 11,
                Font = Enum.Font.GothamBold
            })
            valueLabel.Parent = valueDisplay
            
            -- Slider track
            local sliderTrack = CreateElement("Frame", {
                Name = "SliderTrack",
                Size = UDim2.new(1, -28, 0, 5),
                Position = UDim2.new(0, 14, 0, 38),
                BackgroundColor3 = CONFIG.INPUT_COLOR,
                BorderSizePixel = 0
            })
            sliderTrack.Parent = sliderFrame
            
            AddCorner(sliderTrack, UDim.new(0, 3))
            
            local sliderFill = CreateElement("Frame", {
                Name = "SliderFill",
                Size = UDim2.new(0, 0, 1, 0),
                Position = UDim2.new(0, 0, 0, 0),
                BackgroundColor3 = CONFIG.ACCENT_COLOR,
                BorderSizePixel = 0
            })
            sliderFill.Parent = sliderTrack
            
            AddCorner(sliderFill, UDim.new(0, 3))
            
            -- Slider thumb
            local sliderButton = CreateElement("TextButton", {
                Name = "SliderButton",
                Size = UDim2.new(0, 16, 0, 16),
                Position = UDim2.new(0, -8, 0.5, -8),
                BackgroundColor3 = Color3.new(1, 1, 1),
                BorderSizePixel = 0,
                Text = "",
                AutoButtonColor = false
            })
            sliderButton.Parent = sliderTrack
            
            AddCorner(sliderButton, UDim.new(1, 0))
            
            ToggleStates[flag] = currentValue
            
            local function updateSlider(value)
                value = math.max(range[1], math.min(range[2], value))
                value = math.floor(value / increment + 0.5) * increment
                
                local percentage = (value - range[1]) / (range[2] - range[1])
                
                CreateTween(sliderFill, TweenInfo.new(0.08), {
                    Size = UDim2.new(percentage, 0, 1, 0)
                }):Play()
                CreateTween(sliderButton, TweenInfo.new(0.08), {
                    Position = UDim2.new(percentage, -8, 0.5, -8)
                }):Play()
                
                valueLabel.Text = value .. suffix
                ToggleStates[flag] = value
                callback(value)
            end
            
            updateSlider(currentValue)
            
            local dragging = false
            
            sliderButton.MouseButton1Down:Connect(function()
                dragging = true
                CreateTween(sliderButton, TweenInfo.new(0.1), {
                    Size = UDim2.new(0, 20, 0, 20)
                }):Play()
            end)
            
            local sliderDragConnection = UserInputService.InputChanged:Connect(function(input)
                if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                    local relativeX = input.Position.X - sliderTrack.AbsolutePosition.X
                    local percentage = math.max(0, math.min(1, relativeX / sliderTrack.AbsoluteSize.X))
                    local value = range[1] + (range[2] - range[1]) * percentage
                    updateSlider(value)
                end
            end)
            
            local dragEndConnection = UserInputService.InputEnded:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    dragging = false
                    CreateTween(sliderButton, TweenInfo.new(0.1), {
                        Size = UDim2.new(0, 16, 0, 16)
                    }):Play()
                end
            end)
            
            TrackConnection(sliderDragConnection, window)
            TrackConnection(dragEndConnection, window)
            
            WindowInstances[window].Tabs[tabName].Elements[sliderName] = sliderFrame
            
            task.wait()
            updateCanvasSize()
            
            local element = {}
            function element:Set(value)
                updateSlider(value)
            end
            return element
        end
        
        -- Completely redesigned dropdown with cleaner styling
        function tab:CreateDropdown(options)
            local dropdownName = options.Name or "Dropdown"
            local optionsList = options.Options or {}
            local currentOption = options.CurrentOption or optionsList[1]
            local multipleOptions = options.MultipleOptions or false
            local flag = options.Flag or dropdownName
            local callback = options.Callback or function() end
            
            local dropdownFrame = CreateElement("Frame", {
                Name = "DropdownFrame_" .. dropdownName,
                Size = UDim2.new(1, 0, 0, 64),
                BackgroundColor3 = CONFIG.PANEL_COLOR,
                BorderSizePixel = 0,
                ClipsDescendants = false,
                ZIndex = 30
            })
            dropdownFrame.Parent = tabContent
            
            AddCorner(dropdownFrame, CONFIG.CORNER_RADIUS)
            
            -- Dropdown label
            local label = CreateElement("TextLabel", {
                Name = "Label",
                Size = UDim2.new(1, -28, 0, 18),
                Position = UDim2.new(0, 14, 0, 10),
                BackgroundTransparency = 1,
                Text = dropdownName,
                TextColor3 = CONFIG.TEXT_COLOR,
                TextSize = 13,
                Font = Enum.Font.GothamMedium,
                TextXAlignment = Enum.TextXAlignment.Left,
                ZIndex = 31
            })
            label.Parent = dropdownFrame
            
            -- Dropdown button
            local dropdownButton = CreateElement("TextButton", {
                Name = "DropdownButton",
                Size = UDim2.new(1, -28, 0, 32),
                Position = UDim2.new(0, 14, 0, 26),
                BackgroundColor3 = CONFIG.INPUT_COLOR,
                BorderSizePixel = 0,
                Text = "",
                AutoButtonColor = false,
                ZIndex = 31
            })
            dropdownButton.Parent = dropdownFrame
            
            AddCorner(dropdownButton, CONFIG.CORNER_RADIUS_SM)
            local buttonStroke = AddStroke(dropdownButton, 1, CONFIG.BORDER_COLOR, 0.5)
            
            -- Selected text
            local selectedText = CreateElement("TextLabel", {
                Name = "SelectedText",
                Size = UDim2.new(1, -36, 1, 0),
                Position = UDim2.new(0, 12, 0, 0),
                BackgroundTransparency = 1,
                Text = currentOption or "Select...",
                TextColor3 = currentOption and CONFIG.TEXT_COLOR or CONFIG.MUTED_COLOR,
                TextSize = 12,
                Font = Enum.Font.Gotham,
                TextXAlignment = Enum.TextXAlignment.Left,
                TextTruncate = Enum.TextTruncate.AtEnd,
                ZIndex = 32
            })
            selectedText.Parent = dropdownButton
            
            -- Chevron
            local chevron = CreateElement("TextLabel", {
                Name = "Chevron",
                Size = UDim2.new(0, 20, 1, 0),
                Position = UDim2.new(1, -28, 0, 0),
                BackgroundTransparency = 1,
                Text = "▾",
                TextColor3 = CONFIG.MUTED_COLOR,
                TextSize = 12,
                Font = Enum.Font.GothamBold,
                ZIndex = 33
            })
            chevron.Parent = dropdownButton
            
            -- Options list
            local optionsListFrame = CreateElement("ScrollingFrame", {
                Name = "OptionsList",
                Size = UDim2.new(1, -28, 0, 0),
                Position = UDim2.new(0, 14, 0, 62),
                BackgroundColor3 = CONFIG.SECONDARY_COLOR,
                BorderSizePixel = 0,
                Visible = false,
                ScrollBarThickness = 2,
                ScrollBarImageColor3 = CONFIG.ACCENT_COLOR,
                ScrollBarImageTransparency = 0.5,
                ZIndex = 100,
                TopImage = "rbxassetid://6015897843",
                MidImage = "rbxassetid://6015897843",
                BottomImage = "rbxassetid://6015897843"
            })
            optionsListFrame.Parent = dropdownFrame
            optionsListFrame.ClipsDescendants = true
            
            AddCorner(optionsListFrame, CONFIG.CORNER_RADIUS_SM)
            AddStroke(optionsListFrame, 1, CONFIG.BORDER_COLOR, 0.4)
            
            local listPadding = CreateElement("UIPadding", {
                PaddingTop = UDim.new(0, 4),
                PaddingBottom = UDim.new(0, 4),
                PaddingLeft = UDim.new(0, 4),
                PaddingRight = UDim.new(0, 4)
            })
            listPadding.Parent = optionsListFrame
            
            local listLayout = CreateElement("UIListLayout", {
                SortOrder = Enum.SortOrder.LayoutOrder,
                Padding = UDim.new(0, 2)
            })
            listLayout.Parent = optionsListFrame
            
            local isOpen = false
            local selectedOptions = multipleOptions and {} or currentOption
            
            if multipleOptions and currentOption then
                if type(currentOption) == "table" then
                    selectedOptions = currentOption
                else
                    selectedOptions = {currentOption}
                end
            end
            
            ToggleStates[flag] = selectedOptions
            
            local function updateCanvasSizeDropdown()
                local totalHeight = 0
                for _, child in pairs(optionsListFrame:GetChildren()) do
                    if child:IsA("TextButton") then
                        totalHeight = totalHeight + child.Size.Y.Offset + 2
                    end
                end
                totalHeight = totalHeight + 8
                optionsListFrame.CanvasSize = UDim2.new(0, 0, 0, totalHeight)
                return math.min(totalHeight, 160)
            end
            
            local function updateDropdownText()
                if multipleOptions then
                    if #selectedOptions == 0 then
                        selectedText.Text = "Select..."
                        selectedText.TextColor3 = CONFIG.MUTED_COLOR
                    elseif #selectedOptions == 1 then
                        selectedText.Text = selectedOptions[1]
                        selectedText.TextColor3 = CONFIG.TEXT_COLOR
                    else
                        selectedText.Text = #selectedOptions .. " selected"
                        selectedText.TextColor3 = CONFIG.ACCENT_COLOR
                    end
                else
                    if selectedOptions then
                        selectedText.Text = selectedOptions
                        selectedText.TextColor3 = CONFIG.TEXT_COLOR
                    else
                        selectedText.Text = "Select..."
                        selectedText.TextColor3 = CONFIG.MUTED_COLOR
                    end
                end
            end
            
            local function setOpen(open)
                isOpen = open
                
                if isOpen then
                    local listHeight = updateCanvasSizeDropdown()
                    optionsListFrame.Visible = true
                    optionsListFrame.Size = UDim2.new(1, -28, 0, 0)
                    
                    CreateTween(optionsListFrame, TweenInfo.new(0.2, Enum.EasingStyle.Quart), {
                        Size = UDim2.new(1, -28, 0, listHeight)
                    }):Play()
                    
                    CreateTween(dropdownFrame, TweenInfo.new(0.2, Enum.EasingStyle.Quart), {
                        Size = UDim2.new(1, 0, 0, 68 + listHeight)
                    }):Play()
                    
                    CreateTween(chevron, TweenInfo.new(0.15), {
                        Rotation = 180
                    }):Play()
                    
                    CreateTween(buttonStroke, TweenInfo.new(0.15), {
                        Color = CONFIG.ACCENT_COLOR,
                        Transparency = 0
                    }):Play()
                    
                    dropdownFrame.ZIndex = 50
                    label.ZIndex = 51
                    dropdownButton.ZIndex = 51
                    selectedText.ZIndex = 52
                    chevron.ZIndex = 53
                else
                    CreateTween(optionsListFrame, TweenInfo.new(0.15, Enum.EasingStyle.Quart), {
                        Size = UDim2.new(1, -28, 0, 0)
                    }):Play()
                    
                    CreateTween(dropdownFrame, TweenInfo.new(0.15, Enum.EasingStyle.Quart), {
                        Size = UDim2.new(1, 0, 0, 64)
                    }):Play()
                    
                    CreateTween(chevron, TweenInfo.new(0.15), {
                        Rotation = 0
                    }):Play()
                    
                    CreateTween(buttonStroke, TweenInfo.new(0.15), {
                        Color = CONFIG.BORDER_COLOR,
                        Transparency = 0.5
                    }):Play()
                    
                    task.delay(0.15, function()
                        if not isOpen then
                            optionsListFrame.Visible = false
                            dropdownFrame.ZIndex = 30
                            label.ZIndex = 31
                            dropdownButton.ZIndex = 31
                            selectedText.ZIndex = 32
                            chevron.ZIndex = 33
                        end
                    end)
                end
            end
            
            updateDropdownText()
            
            -- Create option buttons
            local function createOptionButton(i, option)
                local isSelected = multipleOptions and table.find(selectedOptions, option) or selectedOptions == option
                
                local optionButton = CreateElement("TextButton", {
                    Name = "Option_" .. i,
                    Size = UDim2.new(1, 0, 0, 28),
                    BackgroundColor3 = isSelected and CONFIG.ACCENT_COLOR or CONFIG.PANEL_COLOR,
                    BackgroundTransparency = isSelected and 0.85 or 0,
                    BorderSizePixel = 0,
                    Text = "",
                    AutoButtonColor = false,
                    ZIndex = 102
                })
                optionButton.Parent = optionsListFrame
                
                AddCorner(optionButton, CONFIG.CORNER_RADIUS_SM)
                
                local optionLabel = CreateElement("TextLabel", {
                    Size = UDim2.new(1, -28, 1, 0),
                    Position = UDim2.new(0, 10, 0, 0),
                    BackgroundTransparency = 1,
                    Text = option,
                    TextColor3 = isSelected and CONFIG.ACCENT_COLOR or CONFIG.TEXT_COLOR,
                    TextSize = 12,
                    Font = isSelected and Enum.Font.GothamMedium or Enum.Font.Gotham,
                    TextXAlignment = Enum.TextXAlignment.Left,
                    ZIndex = 103
                })
                optionLabel.Parent = optionButton
                
                -- Checkmark
                local checkmark = CreateElement("TextLabel", {
                    Size = UDim2.new(0, 14, 0, 14),
                    Position = UDim2.new(1, -22, 0.5, -7),
                    BackgroundTransparency = 1,
                    Text = "✓",
                    TextColor3 = CONFIG.ACCENT_COLOR,
                    TextSize = 10,
                    Font = Enum.Font.GothamBold,
                    Visible = isSelected,
                    ZIndex = 103
                })
                checkmark.Parent = optionButton
                
                local function updateOptionStyle(selected)
                    CreateTween(optionButton, TweenInfo.new(0.12), {
                        BackgroundColor3 = selected and CONFIG.ACCENT_COLOR or CONFIG.PANEL_COLOR,
                        BackgroundTransparency = selected and 0.85 or 0
                    }):Play()
                    CreateTween(optionLabel, TweenInfo.new(0.12), {
                        TextColor3 = selected and CONFIG.ACCENT_COLOR or CONFIG.TEXT_COLOR
                    }):Play()
                    optionLabel.Font = selected and Enum.Font.GothamMedium or Enum.Font.Gotham
                    checkmark.Visible = selected
                end
                
                optionButton.MouseButton1Click:Connect(function()
                    if multipleOptions then
                        local index = table.find(selectedOptions, option)
                        if index then
                            table.remove(selectedOptions, index)
                            updateOptionStyle(false)
                        else
                            table.insert(selectedOptions, option)
                            updateOptionStyle(true)
                        end
                        updateDropdownText()
                    else
                        for _, child in pairs(optionsListFrame:GetChildren()) do
                            if child:IsA("TextButton") then
                                local childLabel = child:FindFirstChild("TextLabel")
                                local childCheck = child:FindFirstChildWhichIsA("TextLabel", true)
                                if childCheck and childCheck.Text == "✓" then
                                    childCheck.Visible = false
                                end
                                if childLabel then
                                    CreateTween(child, TweenInfo.new(0.12), {
                                        BackgroundColor3 = CONFIG.PANEL_COLOR,
                                        BackgroundTransparency = 0
                                    }):Play()
                                    CreateTween(childLabel, TweenInfo.new(0.12), {
                                        TextColor3 = CONFIG.TEXT_COLOR
                                    }):Play()
                                    childLabel.Font = Enum.Font.Gotham
                                end
                            end
                        end
                        
                        selectedOptions = option
                        updateOptionStyle(true)
                        updateDropdownText()
                        setOpen(false)
                    end
                    
                    ToggleStates[flag] = selectedOptions
                    callback(selectedOptions)
                end)
                
                optionButton.MouseEnter:Connect(function()
                    if not (multipleOptions and table.find(selectedOptions, option) or selectedOptions == option) then
                        CreateTween(optionButton, TweenInfo.new(0.08), {
                            BackgroundColor3 = CONFIG.INPUT_COLOR
                        }):Play()
                    end
                end)
                
                optionButton.MouseLeave:Connect(function()
                    local selected = multipleOptions and table.find(selectedOptions, option) or selectedOptions == option
                    if not selected then
                        CreateTween(optionButton, TweenInfo.new(0.08), {
                            BackgroundColor3 = CONFIG.PANEL_COLOR
                        }):Play()
                    end
                end)
                
                return optionButton
            end
            
            for i, option in ipairs(optionsList) do
                createOptionButton(i, option)
            end
            
            updateCanvasSizeDropdown()
            
            -- Hover effects
            dropdownButton.MouseEnter:Connect(function()
                if not isOpen then
                    CreateTween(dropdownButton, TweenInfo.new(0.12), {
                        BackgroundColor3 = CONFIG.PANEL_COLOR
                    }):Play()
                end
            end)
            
            dropdownButton.MouseLeave:Connect(function()
                if not isOpen then
                    CreateTween(dropdownButton, TweenInfo.new(0.12), {
                        BackgroundColor3 = CONFIG.INPUT_COLOR
                    }):Play()
                end
            end)
            
            dropdownButton.MouseButton1Click:Connect(function()
                setOpen(not isOpen)
            end)
            
            WindowInstances[window].Tabs[tabName].Elements[dropdownName] = dropdownFrame
            
            local element = {}
            function element:Set(opts)
                if multipleOptions then
                    selectedOptions = type(opts) == "table" and opts or {opts}
                else
                    selectedOptions = type(opts) == "table" and opts[1] or opts
                end
                updateDropdownText()
                ToggleStates[flag] = selectedOptions
            end
            
            function element:Refresh(newOptions)
                optionsList = newOptions
                for _, child in pairs(optionsListFrame:GetChildren()) do
                    if child:IsA("TextButton") then
                        child:Destroy()
                    end
                end
                for i, option in ipairs(optionsList) do
                    createOptionButton(i, option)
                end
                updateCanvasSizeDropdown()
                if isOpen then
                    optionsListFrame.Size = UDim2.new(1, -28, 0, updateCanvasSizeDropdown())
                end
            end
            
            return element
        end
        
        -- Improved Input field
        function tab:CreateInput(options)
            local inputName = options.Name or "Input"
            local currentValue = options.CurrentValue or ""
            local placeholderText = options.PlaceholderText or "Enter text..."
            local removeTextAfterFocusLost = options.RemoveTextAfterFocusLost or false
            local flag = options.Flag or inputName
            local callback = options.Callback or function() end
            
            local inputFrame = CreateElement("Frame", {
                Name = "InputFrame_" .. inputName,
                Size = UDim2.new(1, 0, 0, 64),
                BackgroundColor3 = CONFIG.PANEL_COLOR,
                BorderSizePixel = 0
            })
            inputFrame.Parent = tabContent
            
            AddCorner(inputFrame, CONFIG.CORNER_RADIUS)
            
            local label = CreateElement("TextLabel", {
                Name = "Label",
                Size = UDim2.new(1, -28, 0, 18),
                Position = UDim2.new(0, 14, 0, 10),
                BackgroundTransparency = 1,
                Text = inputName,
                TextColor3 = CONFIG.TEXT_COLOR,
                TextSize = 13,
                Font = Enum.Font.GothamMedium,
                TextXAlignment = Enum.TextXAlignment.Left
            })
            label.Parent = inputFrame
            
            local textBoxContainer = CreateElement("Frame", {
                Name = "TextBoxContainer",
                Size = UDim2.new(1, -28, 0, 32),
                Position = UDim2.new(0, 14, 0, 26),
                BackgroundColor3 = CONFIG.INPUT_COLOR,
                BorderSizePixel = 0
            })
            textBoxContainer.Parent = inputFrame
            AddCorner(textBoxContainer, CONFIG.CORNER_RADIUS_SM)
            local inputStroke = AddStroke(textBoxContainer, 1, CONFIG.BORDER_COLOR, 0.5)
            
            local textBox = CreateElement("TextBox", {
                Name = "TextBox",
                Size = UDim2.new(1, -20, 1, 0),
                Position = UDim2.new(0, 10, 0, 0),
                BackgroundTransparency = 1,
                Text = currentValue,
                PlaceholderText = placeholderText,
                PlaceholderColor3 = CONFIG.MUTED_COLOR,
                TextColor3 = CONFIG.TEXT_COLOR,
                TextSize = 12,
                Font = Enum.Font.Gotham,
                TextXAlignment = Enum.TextXAlignment.Left,
                ClearTextOnFocus = false
            })
            textBox.Parent = textBoxContainer
            
            ToggleStates[flag] = currentValue
            
            textBox.Focused:Connect(function()
                CreateTween(inputStroke, TweenInfo.new(0.12), {
                    Color = CONFIG.ACCENT_COLOR,
                    Transparency = 0
                }):Play()
                CreateTween(textBoxContainer, TweenInfo.new(0.12), {
                    BackgroundColor3 = Color3.fromRGB(50, 50, 62)
                }):Play()
            end)
            
            textBox.FocusLost:Connect(function(enterPressed)
                CreateTween(inputStroke, TweenInfo.new(0.12), {
                    Color = CONFIG.BORDER_COLOR,
                    Transparency = 0.5
                }):Play()
                CreateTween(textBoxContainer, TweenInfo.new(0.12), {
                    BackgroundColor3 = CONFIG.INPUT_COLOR
                }):Play()
                
                local text = textBox.Text
                if removeTextAfterFocusLost then
                    textBox.Text = ""
                end
                ToggleStates[flag] = text
                callback(text)
            end)
            
            WindowInstances[window].Tabs[tabName].Elements[inputName] = inputFrame
            
            task.wait()
            updateCanvasSize()
            
            local element = {}
            function element:Set(text)
                textBox.Text = text
                ToggleStates[flag] = text
            end
            return element
        end
        
        -- Select first tab by default
        local tabCountCheck = 0
        for _ in pairs(WindowInstances[window].Tabs) do
            tabCountCheck = tabCountCheck + 1
        end
        
        if tabCountCheck == 1 then
            tabContent.Visible = true
            tabButton.BackgroundTransparency = 0.7
            tabLabel.TextColor3 = CONFIG.TEXT_COLOR
            if tabIcon then
                tabIcon.ImageColor3 = CONFIG.ACCENT_COLOR
            end
            accentIndicator.Visible = true
            accentIndicator.Position = UDim2.new(0, 0, 0.5, -9)
            accentIndicator.BackgroundColor3 = CONFIG.ACCENT_COLOR
            
            CreateTween(tabContent, TweenInfo.new(0.4, Enum.EasingStyle.Quart), {
                BackgroundTransparency = 0
            }):Play()
            
            task.wait()
            updateCanvasSize()
        else
            tabContent.Visible = false
        end
        
        return tab
    end
    
    if onWindowCreated then
        onWindowCreated(window)
    end
    
    return window
end

-- Key System Window
function VortexUI:ShowKeyWindow(callback, keySystemData)
    local function loadSavedKey()
        local success, result = pcall(function()
            if not isfolder("Vortex") then
                makefolder("Vortex")
            end
            
            if isfile("Vortex/Key.txt") then
                local content = readfile("Vortex/Key.txt")
                return content and content:gsub("%s+$", "") or nil
            end
            return nil
        end)
        return success and result or nil
    end
    
    local function saveKey(key)
        pcall(function()
            if not isfolder("Vortex") then
                makefolder("Vortex")
            end
            writefile("Vortex/Key.txt", key)
        end)
    end
    
    local function isSavedKeyValid(savedKey)
        if not savedKey then return false end
        for _, validKey in ipairs(keySystemData.ValidKeys) do
            if savedKey == validKey then
                return true
            end
        end
        return false
    end
    
    local savedKey = loadSavedKey()
    if isSavedKeyValid(savedKey) then
        KeySystem.LastValidKey = savedKey
        KeySystem.Authenticated = true
        callback(true)
        return
    end
    
    if KeySystem.LastValidKey then
        for _, validKey in ipairs(keySystemData.ValidKeys) do
            if KeySystem.LastValidKey == validKey then
                saveKey(KeySystem.LastValidKey)
                KeySystem.Authenticated = true
                callback(true)
                return
            end
        end
        KeySystem.LastValidKey = nil
    end
    
    local CoreGui = game:GetService("CoreGui")
    for _, child in ipairs(CoreGui:GetChildren()) do
        if child.Name == "VortexKeyWindow" then
            child:Destroy()
        end
    end
    
    local screenGui = CreateElement("ScreenGui", {
        Name = "VortexKeyWindow",
        IgnoreGuiInset = true,
        ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    })
    screenGui.Parent = CoreGui
    
    local keyWindowName = "VortexKeyWindow"
    local cleanupCalled = false
    
    local destructionConnection
    destructionConnection = game:GetService("RunService").Heartbeat:Connect(function()
        if not screenGui or not screenGui.Parent then
            if not cleanupCalled then
                cleanupCalled = true
                if destructionConnection then
                    destructionConnection:Disconnect()
                end
                callback(false)
            end
        end
    end)
    
    local coreGuiConnection
    coreGuiConnection = CoreGui.ChildRemoved:Connect(function(child)
        if child.Name == keyWindowName then
            if not cleanupCalled then
                cleanupCalled = true
                if destructionConnection then
                    destructionConnection:Disconnect()
                end
                if coreGuiConnection then
                    coreGuiConnection:Disconnect()
                end
                callback(false)
            end
        end
    end)
    
    -- Overlay
    local overlay = CreateElement("Frame", {
        Name = "Overlay",
        Size = UDim2.new(1, 0, 1, 0),
        Position = UDim2.new(0, 0, 0, 0),
        BackgroundColor3 = Color3.fromRGB(0, 0, 0),
        BackgroundTransparency = 0.4,
        BorderSizePixel = 0
    })
    overlay.Parent = screenGui
    
    overlay.BackgroundTransparency = 1
    CreateTween(overlay, TweenInfo.new(0.25), {
        BackgroundTransparency = 0.4
    }):Play()
    
    -- Key window
    local keyWindow = CreateElement("Frame", {
        Name = "KeyWindow",
        Size = UDim2.new(0, 360, 0, 300),
        Position = UDim2.new(0.5, -180, 0.5, -150),
        BackgroundColor3 = CONFIG.PRIMARY_COLOR,
        BorderSizePixel = 0
    })
    keyWindow.Parent = overlay
    
    AddCorner(keyWindow, CONFIG.CORNER_RADIUS_XL)
    AddStroke(keyWindow, 1, CONFIG.BORDER_COLOR, 0.4)
    AddDropShadow(keyWindow, 32, 0.5)
    
    -- Animated entrance
    keyWindow.Size = UDim2.new(0, 0, 0, 0)
    keyWindow.Position = UDim2.new(0.5, 0, 0.5, 0)
    keyWindow.BackgroundTransparency = 1
    
    CreateTween(keyWindow, TweenInfo.new(0.35, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
        Size = UDim2.new(0, 360, 0, 300),
        Position = UDim2.new(0.5, -180, 0.5, -150),
        BackgroundTransparency = 0
    }):Play()
    
    -- Accent header strip
    local headerAccent = CreateElement("Frame", {
        Name = "HeaderAccent",
        Size = UDim2.new(1, 0, 0, 4),
        Position = UDim2.new(0, 0, 0, 0),
        BackgroundColor3 = CONFIG.ACCENT_COLOR,
        BorderSizePixel = 0
    })
    headerAccent.Parent = keyWindow
    
    local accentCorner = Instance.new("UICorner")
    accentCorner.CornerRadius = CONFIG.CORNER_RADIUS_XL
    accentCorner.Parent = headerAccent
    
    local accentCover = CreateElement("Frame", {
        Size = UDim2.new(1, 0, 0.5, 0),
        Position = UDim2.new(0, 0, 0.5, 0),
        BackgroundColor3 = CONFIG.ACCENT_COLOR,
        BorderSizePixel = 0
    })
    accentCover.Parent = headerAccent
    
    -- Lock icon
    local iconContainer = CreateElement("Frame", {
        Name = "IconContainer",
        Size = UDim2.new(0, 50, 0, 50),
        Position = UDim2.new(0.5, -25, 0, 24),
        BackgroundColor3 = CONFIG.ACCENT_COLOR,
        BackgroundTransparency = 0.9,
        BorderSizePixel = 0
    })
    iconContainer.Parent = keyWindow
    AddCorner(iconContainer, UDim.new(1, 0))
    
    local lockIcon = CreateElement("TextLabel", {
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        Text = "🔐",
        TextColor3 = CONFIG.ACCENT_COLOR,
        TextSize = 22,
        Font = Enum.Font.GothamBold
    })
    lockIcon.Parent = iconContainer
    
    -- Title
    local titleLabel = CreateElement("TextLabel", {
        Size = UDim2.new(1, -48, 0, 24),
        Position = UDim2.new(0, 24, 0, 82),
        BackgroundTransparency = 1,
        Text = "Authentication Required",
        TextColor3 = CONFIG.TEXT_COLOR,
        TextSize = 16,
        Font = Enum.Font.GothamBold,
        TextXAlignment = Enum.TextXAlignment.Center
    })
    titleLabel.Parent = keyWindow
    
    -- Description
    local descLabel = CreateElement("TextLabel", {
        Size = UDim2.new(1, -48, 0, 36),
        Position = UDim2.new(0, 24, 0, 108),
        BackgroundTransparency = 1,
        Text = "Enter your access key to continue",
        TextColor3 = CONFIG.SUB_TEXT_COLOR,
        TextSize = 12,
        Font = Enum.Font.Gotham,
        TextWrapped = true
    })
    descLabel.Parent = keyWindow
    
    -- Key input
    local keyInputFrame = CreateElement("Frame", {
        Name = "KeyInputFrame",
        Size = UDim2.new(1, -48, 0, 40),
        Position = UDim2.new(0, 24, 0, 150),
        BackgroundColor3 = CONFIG.INPUT_COLOR,
        BorderSizePixel = 0
    })
    keyInputFrame.Parent = keyWindow
    AddCorner(keyInputFrame, CONFIG.CORNER_RADIUS)
    local keyInputStroke = AddStroke(keyInputFrame, 1, CONFIG.BORDER_COLOR, 0.4)
    
    local keyInput = CreateElement("TextBox", {
        Name = "KeyInput",
        Size = UDim2.new(1, -24, 1, 0),
        Position = UDim2.new(0, 12, 0, 0),
        BackgroundTransparency = 1,
        Text = "",
        PlaceholderText = "Enter key...",
        PlaceholderColor3 = CONFIG.MUTED_COLOR,
        TextColor3 = CONFIG.TEXT_COLOR,
        TextSize = 13,
        Font = Enum.Font.Gotham,
        TextXAlignment = Enum.TextXAlignment.Left,
        ClearTextOnFocus = false
    })
    keyInput.Parent = keyInputFrame
    
    keyInput.Focused:Connect(function()
        CreateTween(keyInputStroke, TweenInfo.new(0.12), {
            Color = CONFIG.ACCENT_COLOR,
            Transparency = 0
        }):Play()
    end)
    
    keyInput.FocusLost:Connect(function()
        CreateTween(keyInputStroke, TweenInfo.new(0.12), {
            Color = CONFIG.BORDER_COLOR,
            Transparency = 0.4
        }):Play()
    end)
    
    -- Status label
    local statusLabel = CreateElement("TextLabel", {
        Size = UDim2.new(1, -48, 0, 18),
        Position = UDim2.new(0, 24, 0, 196),
        BackgroundTransparency = 1,
        Text = "",
        TextColor3 = CONFIG.ERROR_COLOR,
        TextSize = 11,
        Font = Enum.Font.GothamMedium,
        TextXAlignment = Enum.TextXAlignment.Center
    })
    statusLabel.Parent = keyWindow
    
    -- Submit button
    local submitButton = CreateElement("TextButton", {
        Name = "VortexSubmitButton",
        Size = UDim2.new(1, -48, 0, 40),
        Position = UDim2.new(0, 24, 0, 220),
        BackgroundColor3 = CONFIG.ACCENT_COLOR,
        BorderSizePixel = 0,
        Text = "Authenticate",
        TextColor3 = Color3.new(1, 1, 1),
        TextSize = 13,
        Font = Enum.Font.GothamBold,
        AutoButtonColor = false
    })
    submitButton.Parent = keyWindow
    
    AddCorner(submitButton, CONFIG.CORNER_RADIUS)
    
    submitButton.MouseEnter:Connect(function()
        CreateTween(submitButton, TweenInfo.new(0.12), {
            BackgroundColor3 = CONFIG.ACCENT_HOVER
        }):Play()
    end)
    
    submitButton.MouseLeave:Connect(function()
        CreateTween(submitButton, TweenInfo.new(0.12), {
            BackgroundColor3 = CONFIG.ACCENT_COLOR
        }):Play()
    end)
    
    -- Close button
    local closeButton = CreateElement("TextButton", {
        Name = "CloseButton",
        Size = UDim2.new(0, 28, 0, 28),
        Position = UDim2.new(1, -38, 0, 10),
        BackgroundColor3 = CONFIG.PANEL_COLOR,
        BackgroundTransparency = 1,
        BorderSizePixel = 0,
        Text = "×",
        TextColor3 = CONFIG.MUTED_COLOR,
        TextSize = 18,
        Font = Enum.Font.GothamBold,
        AutoButtonColor = false
    })
    closeButton.Parent = keyWindow
    AddCorner(closeButton, UDim.new(1, 0))
    
    closeButton.MouseEnter:Connect(function()
        CreateTween(closeButton, TweenInfo.new(0.12), {
            BackgroundTransparency = 0,
            BackgroundColor3 = CONFIG.ERROR_COLOR
        }):Play()
        CreateTween(closeButton, TweenInfo.new(0.12), {
            TextColor3 = Color3.new(1, 1, 1)
        }):Play()
    end)
    
    closeButton.MouseLeave:Connect(function()
        CreateTween(closeButton, TweenInfo.new(0.12), {
            BackgroundTransparency = 1
        }):Play()
        CreateTween(closeButton, TweenInfo.new(0.12), {
            TextColor3 = CONFIG.MUTED_COLOR
        }):Play()
    end)
    
    -- Submit functionality
    submitButton.MouseButton1Click:Connect(function()
        local enteredKey = keyInput.Text
        
        if enteredKey == "" then
            statusLabel.Text = "Please enter a key"
            statusLabel.TextColor3 = CONFIG.ERROR_COLOR
            
            local originalPos = keyInputFrame.Position
            for i = 1, 3 do
                CreateTween(keyInputFrame, TweenInfo.new(0.04), {
                    Position = UDim2.new(originalPos.X.Scale, originalPos.X.Offset + 4, originalPos.Y.Scale, originalPos.Y.Offset)
                }):Play()
                task.wait(0.04)
                CreateTween(keyInputFrame, TweenInfo.new(0.04), {
                    Position = UDim2.new(originalPos.X.Scale, originalPos.X.Offset - 4, originalPos.Y.Scale, originalPos.Y.Offset)
                }):Play()
                task.wait(0.04)
            end
            CreateTween(keyInputFrame, TweenInfo.new(0.04), {
                Position = originalPos
            }):Play()
            return
        end
        
        submitButton.Text = "Validating..."
        
        local isValidKey = false
        for _, validKey in ipairs(keySystemData.ValidKeys) do
            if enteredKey == validKey then
                isValidKey = true
                break
            end
        end
        
        if isValidKey then
            statusLabel.Text = "✓ Success!"
            statusLabel.TextColor3 = CONFIG.SUCCESS_COLOR
            
            CreateTween(submitButton, TweenInfo.new(0.2), {
                BackgroundColor3 = CONFIG.SUCCESS_COLOR
            }):Play()
            submitButton.Text = "Authenticated"
            
            KeySystem.LastValidKey = enteredKey
            saveKey(enteredKey)
            
            task.wait(0.8)
            
            CreateTween(keyWindow, TweenInfo.new(0.25, Enum.EasingStyle.Back, Enum.EasingDirection.In), {
                Size = UDim2.new(0, 0, 0, 0),
                Position = UDim2.new(0.5, 0, 0.5, 0),
                BackgroundTransparency = 1
            }):Play()
            
            CreateTween(overlay, TweenInfo.new(0.25), {
                BackgroundTransparency = 1
            }):Play()
            
            task.wait(0.25)
            screenGui:Destroy()
            callback(true)
        else
            statusLabel.Text = "Invalid key"
            statusLabel.TextColor3 = CONFIG.ERROR_COLOR
            
            local originalPos = keyWindow.Position
            for i = 1, 2 do
                CreateTween(keyWindow, TweenInfo.new(0.04), {
                    Position = UDim2.new(originalPos.X.Scale, originalPos.X.Offset + 6, originalPos.Y.Scale, originalPos.Y.Offset)
                }):Play()
                task.wait(0.04)
                CreateTween(keyWindow, TweenInfo.new(0.04), {
                    Position = UDim2.new(originalPos.X.Scale, originalPos.X.Offset - 6, originalPos.Y.Scale, originalPos.Y.Offset)
                }):Play()
                task.wait(0.04)
            end
            CreateTween(keyWindow, TweenInfo.new(0.04), {
                Position = originalPos
            }):Play()
            
            submitButton.Text = "Authenticate"
            CreateTween(submitButton, TweenInfo.new(0.2), {
                BackgroundColor3 = CONFIG.ACCENT_COLOR
            }):Play()
        end
    end)
    
    closeButton.MouseButton1Click:Connect(function()
        CreateTween(keyWindow, TweenInfo.new(0.25, Enum.EasingStyle.Back, Enum.EasingDirection.In), {
            Size = UDim2.new(0, 0, 0, 0),
            Position = UDim2.new(0.5, 0, 0.5, 0),
            BackgroundTransparency = 1
        }):Play()
        
        CreateTween(overlay, TweenInfo.new(0.25), {
            BackgroundTransparency = 1
        }):Play()
        
        task.wait(0.25)
        screenGui:Destroy()
        callback(false)
    end)
    
    keyInput.FocusLost:Connect(function(enterPressed)
        if enterPressed then
            submitButton.MouseButton1Click:Fire()
        end
    end)
end

return VortexUI
